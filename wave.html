<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DIGIY LOC PRO â™¾ï¸ â€” Cockpit Wave</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="./guard.js?v=wave-stable"></script>
</head>

<body>
<div style="padding:20px;color:white;font-family:sans-serif;background:#020617;min-height:100vh">
<h2>ğŸ’³ Cockpit Wave â€” DIGIY LOC PRO</h2>
<button id="btnDeclare">â• Ajouter un paiement</button>
<button id="btnReload">â†» Reload</button>
<hr/>
<div id="stats"></div>
<div id="list"></div>
<div id="note"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
(async function(){
"use strict";

/* CONFIG */
const SUPABASE_URL="https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

const RPC_STATS="loc_wave_payments_stats_owner_v2";
const RPC_LIST="loc_wave_payments_list_owner_v2";
const RPC_VERIFY="loc_wave_payment_verify_v2";
const RPC_DECLARE="loc_wave_payment_declare_owner_v2";

/* SB fallback */
let SB=null;
function getSB(){
if(window.DIGIY_GUARD?.sb) return window.DIGIY_GUARD.sb;
if(!SB) SB=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
return SB;
}

function slug(){return DIGIY_GUARD?.getSlug?.()||"";}
function owner(){return DIGIY_GUARD?.getSession?.()?.owner_id||"";}

function note(t,c="white"){
const n=document.getElementById("note");
n.style.color=c;n.innerText=t||"";
}

function money(n){
return Number(n||0).toLocaleString("fr-FR")+" FCFA";
}

/* LOAD */
async function load(){
const sb=getSB();
const s=slug(),o=owner();
if(!s||!o){note("Session manquante","red");return;}

const {data:st}=await sb.rpc(RPC_STATS,{p_slug:s,p_owner_id:o});
document.getElementById("stats").innerText=JSON.stringify(st,null,2);

const {data:ls}=await sb.rpc(RPC_LIST,{p_slug:s,p_owner_id:o,p_limit:50});
document.getElementById("list").innerText=JSON.stringify(ls,null,2);
}

/* DECLARE */
document.getElementById("btnDeclare").addEventListener("click", async()=>{
try{
const sb=getSB();
const s=slug(),o=owner();
const a=prompt("Montant reÃ§u ?");
if(!a) return;
const amt=Number(a.replace(/[^\d]/g,""));
const {data,error}=await sb.rpc(RPC_DECLARE,{
p_slug:s,p_owner_id:o,p_amount_fcfa:amt,p_client_name:"Test",p_client_phone:null,p_proof_url:null,p_logement_title:null
});
if(error) throw error;
note("âœ… dÃ©clarÃ©","lime");
await load();
}catch(e){note("âŒ "+e.message,"red");}
});

document.getElementById("btnReload").onclick=()=>load();

await load();

})();
});
</script>
</body>
</html>
