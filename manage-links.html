<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY ‚ôæÔ∏è ‚Äî Liens / QR</title>
  <meta name="theme-color" content="#0b1020"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./guard.js?v=locpro-final"></script>

  <style>
    :root{
      --bg:#020617; --bg2:#0b1020; --line:rgba(148,163,184,.22);
      --ink:#f9fafb; --muted:#cbd5f5;
      --gold:#facc15; --green:#22c55e; --red:#ef4444;
      --card:rgba(255,255,255,.03); --shadow:0 22px 50px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 520px at 12% -10%, rgba(250,204,21,.16), transparent 60%),
        radial-gradient(900px 520px at 90% 0%, rgba(34,197,94,.12), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      padding:16px;
    }
    .wrap{max-width:1040px;margin:0 auto}
    .top{
      display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;
      padding:12px;border:1px solid var(--line);border-radius:18px;background:var(--card);
      box-shadow:var(--shadow);
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:16px;
      background:linear-gradient(135deg, rgba(250,204,21,.35), rgba(34,197,94,.2));
      border:1px solid rgba(250,204,21,.35);
      display:grid;place-items:center;color:#061b14;font-weight:1100;
    }
    h1{font-size:1.06rem}
    .sub{color:var(--muted);font-weight:850;margin-top:4px}
    .pill{
      border:1px solid rgba(148,163,184,.35);
      padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.02);
      color:var(--muted);font-weight:900;font-size:.86rem;
    }
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    .card{
      border:1px solid var(--line);background:rgba(255,255,255,.03);
      border-radius:20px;box-shadow:var(--shadow);padding:16px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      min-height:46px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);color:#fff;font-weight:1100;font-size:15px;
      cursor:pointer;text-decoration:none; padding:10px 12px;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
    }
    .btn.primary{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}
    .btn.gold{background:rgba(250,204,21,.10);border-color:rgba(250,204,21,.35)}
    .btn.red{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.35)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .note{
      margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(148,163,184,.25);
      background:rgba(255,255,255,.03);color:var(--muted);font-weight:900;white-space:pre-wrap;display:none;
    }
    .note.ok{display:block;border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.09);color:#bbf7d0}
    .note.bad{display:block;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.09);color:#fecaca}
    .note.warn{display:block;border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.09);color:#fde68a}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid rgba(148,163,184,.18);text-align:left;font-weight:850;vertical-align:top}
    th{color:rgba(203,213,245,.9);font-size:.85rem}
    td{color:#f9fafb;font-size:.95rem}

    .tiny{color:rgba(203,213,245,.9);font-weight:850;font-size:.9rem;line-height:1.35;margin-top:10px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}

    .field{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(0,0,0,.18);
      color:#fff;
      font-weight:900;
      outline:none;
    }
    .field:focus{
      border-color:rgba(250,204,21,.45);
      box-shadow:0 0 0 3px rgba(250,204,21,.12);
    }
    .miniBtn{
      min-height:40px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(255,255,255,.04);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .miniBtn.red{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10)}
    .miniBtn.gold{border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.10)}
    .miniBtn.green{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10)}
    .miniBtn:disabled{opacity:.55;cursor:not-allowed}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">‚àû</div>
      <div>
        <h1>DIGIY ‚ôæÔ∏è ‚Äî Liens / QR</h1>
        <div class="sub">Z√©ro email ¬∑ Z√©ro magic link ¬∑ Session PIN (Guard)</div>
      </div>
    </div>
    <div class="pill" id="pillSlug">slug : ‚Äî</div>
  </div>

  <div class="grid">
    <!-- SESSION -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:950">üîê Session</div>
        <div class="pill" id="pillStatus">‚Äî</div>
      </div>

      <div class="tiny" id="who">‚Äî</div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnLoad" type="button">‚Üª Charger</button>
        <button class="btn gold" id="btnSave" type="button">üíæ Enregistrer</button>
        <button class="btn red" id="btnReset" type="button">üßπ Vider</button>
        <a class="btn" id="btnBack" href="#">‚¨ÖÔ∏è Retour cockpit</a>
      </div>

      <div class="row" style="margin-top:12px">
        <a class="btn" id="btnOpenApp" href="#">üè† Ouvrir APP</a>
        <a class="btn" id="btnOpenPublic" href="#">üëÅÔ∏è Fiche publique</a>
        <a class="btn" id="btnOpenPin" href="#">üîë Acc√®s (PIN)</a>
        <button class="btn" id="btnCopyAll" type="button">üìã Copier URLs</button>
      </div>

      <div class="note warn" id="note"></div>
    </div>

    <!-- LINKS -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
        <div style="font-weight:950">üîó GO LINKS</div>
        <div class="row">
          <button class="btn" id="btnAdd" type="button">‚ûï Nouveau lien</button>
          <button class="btn" id="btnSort" type="button">‚ÜïÔ∏è Trier</button>
        </div>
      </div>

      <div class="tiny">
        Ces liens deviennent des boutons (Commander / R√©server / WhatsApp / etc.).
        Conseil terrain : mets <span class="mono">order</span> par pas de 10 (10, 20, 30).
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:90px">Ordre</th>
            <th style="min-width:180px">Label</th>
            <th>URL</th>
            <th style="width:90px">Actif</th>
            <th style="width:240px">Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <!-- QR -->
    <div class="card">
      <div style="font-weight:950">‚¨áÔ∏è QR (t√©l√©chargement)</div>
      <div class="tiny">QR-PRO ‚Üí <span class="mono" id="qrProUrl">‚Äî</span></div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnQrApp" type="button">‚¨áÔ∏è QR APP</button>
        <button class="btn" id="btnQrPublic" type="button">‚¨áÔ∏è QR Public</button>
        <button class="btn" id="btnQrPin" type="button">‚¨áÔ∏è QR Acc√®s</button>
        <button class="btn" id="btnCopyQr" type="button">üìã Copier QR-PRO</button>
      </div>
      <div class="tiny" id="qrInfo" style="margin-top:10px">‚Äî</div>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";
  const $ = (id)=>document.getElementById(id);

  // =========================
  // CONFIG SUPABASE (fallback)
  // =========================
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  // =========================
  // UI helpers
  // =========================
  function show(msg, cls){
    const el = $("note");
    el.className = "note " + (cls || "warn");
    el.textContent = msg || "";
    el.style.display = msg ? "block" : "none";
  }

  function copyText(txt){
    try{ return navigator.clipboard.writeText(txt).then(()=>true).catch(()=>false); }
    catch(_){
      try{
        const ta = document.createElement("textarea");
        ta.value = txt; document.body.appendChild(ta);
        ta.select(); document.execCommand("copy");
        ta.remove();
        return Promise.resolve(true);
      }catch(__){ return Promise.resolve(false); }
    }
  }

  // =========================
  // Slug + phones
  // =========================
  function getSlug(){
    return (window.DIGIY_GUARD?.getSlug?.() || new URL(location.href).searchParams.get("slug") || "").trim();
  }

  function normPhone(p){
    p = String(p||"").trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");
    if(p.startsWith("00221")) p = "+221" + p.slice(5);
    if(!p.startsWith("+") && p.startsWith("221")) p = "+" + p;
    if(!p.startsWith("+221") && /^\d{9}$/.test(p)) p = "+221" + p;
    return p;
  }

  function pin4FromPhone(phone){
    const p = normPhone(phone);
    return p ? p.slice(-4) : "";
  }

  function digitsOnly(p){ return String(p||"").replace(/\D/g,""); }

  // =========================
  // Supabase getter (guard -> fallback local)
  // =========================
  async function getSB(){
    try{
      if(window.DIGIY_GUARD?.getSbAsync) return await window.DIGIY_GUARD.getSbAsync();
      const sb1 = window.DIGIY_GUARD?.getSb?.();
      if(sb1) return sb1;
    }catch(e){ console.warn("guard sb fail", e); }
    try{
      return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }catch(e){
      console.error(e);
      return null;
    }
  }

  // =========================
  // Pages / URLs du module
  // =========================
  const slug = getSlug();
  $("pillSlug").textContent = "slug : " + (slug || "‚Äî");

  // Pages LOC-PRO (tes vrais fichiers)
  const PAGE_APP    = "./index.html";
  const PAGE_PUBLIC = "./go-pin-public.html";
  const PAGE_PIN    = "./pin.html";

  const appUrl = new URL(PAGE_APP, location.href);
  const publicUrl = new URL(PAGE_PUBLIC, location.href);
  const pinUrl = new URL(PAGE_PIN, location.href);

  if(slug){
    appUrl.searchParams.set("slug", slug);
    publicUrl.searchParams.set("slug", slug);
    pinUrl.searchParams.set("slug", slug);
  }

  $("btnBack").href = appUrl.toString();
  $("btnOpenApp").href = appUrl.toString();
  $("btnOpenPublic").href = publicUrl.toString();
  $("btnOpenPin").href = pinUrl.toString();

  $("btnCopyAll").addEventListener("click", async ()=>{
    const pack =
`DIGIY URLs
slug: ${slug || "‚Äî"}

APP: ${appUrl.toString()}
PUBLIC: ${publicUrl.toString()}
PIN: ${pinUrl.toString()}
`;
    const ok = await copyText(pack);
    show(ok ? "‚úÖ URLs copi√©es." : "‚ùå Copie impossible (navigateur).", ok ? "ok" : "bad");
  });

  // =========================
  // QR-PRO officiel
  // =========================
  const QR_PRO_BASE = "https://beauville.github.io/digiy-qr-pro/";
  const qrPro = new URL(QR_PRO_BASE);
  if(slug) qrPro.searchParams.set("slug", slug);
  $("qrProUrl").textContent = qrPro.toString();
  $("qrInfo").textContent = "QR-PRO centralise tes QR (app/public/pin).";

  function openQrPro(type){
    const u = new URL(QR_PRO_BASE);
    if(slug) u.searchParams.set("slug", slug);
    if(type) u.searchParams.set("t", type);
    window.open(u.toString(), "_blank", "noopener,noreferrer");
    $("qrInfo").textContent = "Ouvert QR-PRO (" + (type || "‚Äî") + ") ‚Üí " + u.toString();
  }
  $("btnQrApp").addEventListener("click", ()=> openQrPro("app"));
  $("btnQrPublic").addEventListener("click", ()=> openQrPro("public"));
  $("btnQrPin").addEventListener("click", ()=> openQrPro("pin"));
  $("btnCopyQr").addEventListener("click", async ()=>{
    const ok = await copyText(qrPro.toString());
    show(ok ? "‚úÖ Lien QR-PRO copi√©." : "‚ùå Copie impossible.", ok ? "ok" : "bad");
  });

  // =========================
  // LINKS model (local state)
  // =========================
  let LINKS = [];

  function nextOrder(){
    const max = LINKS.reduce((m,x)=>Math.max(m, Number(x.order||0)), 0);
    return (max ? (Math.ceil(max/10)*10 + 10) : 10);
  }

  function normalizeUrl(u){
    u = String(u||"").trim();
    if(!u) return "";

    // WhatsApp convenience: "22177..." or "+221..." => wa.me
    if(/^\+?\d{9,15}$/.test(u.replace(/\s+/g,""))){
      const d = digitsOnly(u);
      return "https://wa.me/" + d;
    }

    // If user pastes wa.me without protocol
    if(/^wa\.me\//i.test(u)) return "https://" + u;

    // Basic allowlist
    const lower = u.toLowerCase();
    if(lower.startsWith("javascript:") || lower.startsWith("data:")) return "";

    // Auto add https if looks like domain
    if(!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(u)){
      // no scheme
      if(u.includes(".")) u = "https://" + u;
    }

    return u;
  }

  function validateLinks(list){
    const clean = [];
    for(const x of (list||[])){
      const label = String(x.label||"").trim();
      const url = normalizeUrl(x.url||"");
      const order = Number(x.order||100);
      const active = !!x.active;
      if(!label || !url) continue;
      clean.push({ order, label, url, active });
    }
    // Sort by order then label
    clean.sort((a,b)=>(a.order-b.order) || a.label.localeCompare(b.label));
    return clean;
  }

  // =========================
  // DOM rendering (SAFE)
  // =========================
  function makeEl(tag, attrs, children){
    const el = document.createElement(tag);
    if(attrs){
      for(const [k,v] of Object.entries(attrs)){
        if(k==="class") el.className = v;
        else if(k==="text") el.textContent = v;
        else if(k==="html") el.innerHTML = v;
        else el.setAttribute(k, String(v));
      }
    }
    (children||[]).forEach(ch=> el.appendChild(ch));
    return el;
  }

  function render(){
    const tb = $("rows");
    tb.innerHTML = "";

    if(!LINKS.length){
      tb.appendChild(makeEl("tr", null, [
        makeEl("td", { colspan:"5", style:"color:rgba(203,213,245,.9)" , text:"‚Äî aucun lien ‚Äî" })
      ]));
      return;
    }

    // Stable sort for display
    const display = LINKS.map((x,idx)=>({x,idx}))
      .sort((a,b)=> (Number(a.x.order||999)-Number(b.x.order||999)) || (a.idx-b.idx));

    for(const it of display){
      const i = it.idx;
      const x = LINKS[i];

      const tr = document.createElement("tr");

      // order
      const order = makeEl("input", { class:"field", type:"number", value:String(Number(x.order||100)), style:"width:90px" });
      order.addEventListener("change", ()=>{ x.order = Number(order.value||100); });

      // label
      const label = makeEl("input", { class:"field", value:String(x.label||""), placeholder:"Ex: WhatsApp / R√©server / Commander" });
      label.addEventListener("change", ()=>{ x.label = String(label.value||"").trim(); });

      // url
      const url = makeEl("input", { class:"field", value:String(x.url||""), placeholder:"https://... ou wa.me/..." });
      url.addEventListener("change", ()=>{
        const n = normalizeUrl(url.value);
        if(!n){
          show("‚ö†Ô∏è URL invalide (refus√©e). Utilise https://..., tel:..., mailto:..., wa.me/...", "warn");
          url.value = "";
          x.url = "";
          return;
        }
        url.value = n;
        x.url = n;
      });

      // active
      const sel = document.createElement("select");
      sel.className = "field";
      sel.style.width = "90px";
      sel.innerHTML = `
        <option value="true">Oui</option>
        <option value="false">Non</option>
      `;
      sel.value = x.active ? "true" : "false";
      sel.addEventListener("change", ()=>{ x.active = (sel.value==="true"); });

      // actions
      const actions = makeEl("div", { class:"row" });
      const bTest = makeEl("button", { class:"miniBtn", type:"button", text:"üîé Tester" });
      const bCopy = makeEl("button", { class:"miniBtn gold", type:"button", text:"üìã Copier" });
      const bDup  = makeEl("button", { class:"miniBtn green", type:"button", text:"üìé Dupliquer" });
      const bDel  = makeEl("button", { class:"miniBtn red", type:"button", text:"üóëÔ∏è" });

      bTest.addEventListener("click", ()=>{
        const u = normalizeUrl(x.url||"");
        if(!u){ show("‚ùå URL vide/invalide.", "bad"); return; }
        window.open(u, "_blank", "noopener,noreferrer");
        show("‚úÖ Test ouverture : " + u, "ok");
      });

      bCopy.addEventListener("click", async ()=>{
        const u = normalizeUrl(x.url||"");
        if(!u){ show("‚ùå URL vide/invalide.", "bad"); return; }
        const ok = await copyText(u);
        show(ok ? "‚úÖ URL copi√©e." : "‚ùå Copie impossible.", ok ? "ok" : "bad");
      });

      bDup.addEventListener("click", ()=>{
        LINKS.push({ order: nextOrder(), label: (x.label||"") + " (copy)", url: x.url||"", active: x.active!==false });
        render();
        show("‚úÖ Lien dupliqu√©.", "ok");
      });

      bDel.addEventListener("click", ()=>{
        LINKS.splice(i, 1);
        render();
        show("Lien supprim√© (pense √† Enregistrer).", "warn");
      });

      actions.appendChild(bTest);
      actions.appendChild(bCopy);
      actions.appendChild(bDup);
      actions.appendChild(bDel);

      // append tds
      tr.appendChild(makeEl("td", null, [order]));
      tr.appendChild(makeEl("td", null, [label]));
      tr.appendChild(makeEl("td", null, [url]));
      tr.appendChild(makeEl("td", null, [sel]));
      tr.appendChild(makeEl("td", null, [actions]));

      tb.appendChild(tr);
    }
  }

  // =========================
  // RPC creds (session)
  // =========================
  function getCreds(){
    const sess = window.DIGIY_GUARD?.getSession?.() || null;
    const phone = normPhone(sess?.phone || "");
    const pin4 = pin4FromPhone(phone);
    return { sess, phone, pin4 };
  }

  async function loadLinks(){
    const sb = await getSB();
    if(!sb) return show("‚ùå Supabase pas pr√™t (sb null). Recharge.", "bad");
    if(!slug) return show("‚ùå slug manquant. Ouvre depuis le cockpit.", "bad");

    const { sess, phone, pin4 } = getCreds();
    if(!sess?.ok || !phone) return show("‚ö†Ô∏è Session manquante. Retourne sur PIN.", "bad");
    if(!pin4) return show("‚ö†Ô∏è PIN4 absent. V√©rifie ton t√©l√©phone session.", "bad");

    $("btnLoad").disabled = true;
    show("‚è≥ Chargement‚Ä¶", "warn");

    try{
      const { data, error } = await sb.rpc("digiy_go_links_get", {
        p_slug: slug,
        p_phone: phone,
        p_pin4: pin4
      });

      if(error) return show("‚ùå Erreur: " + (error.message || error), "bad");
      if(!data?.ok) return show("‚ùå Acc√®s refus√©: " + (data?.error || "unknown"), "bad");

      LINKS = Array.isArray(data.links) ? data.links.map(x=>({
        order:Number(x.order||100),
        label:String(x.label||"").trim(),
        url:String(x.url||"").trim(),
        active: x.active!==false
      })) : [];

      render();
      show("‚úÖ Liens charg√©s.", "ok");

    }catch(e){
      console.error(e);
      show("‚ùå Crash chargement: " + String(e?.message||e), "bad");
    }finally{
      $("btnLoad").disabled = false;
    }
  }

  async function saveLinks(){
    const sb = await getSB();
    if(!sb) return show("‚ùå Supabase pas pr√™t (sb null).", "bad");
    if(!slug) return show("‚ùå slug manquant.", "bad");

    const { sess, phone, pin4 } = getCreds();
    if(!sess?.ok || !phone) return show("‚ö†Ô∏è Session manquante. Retour PIN.", "bad");
    if(!pin4) return show("‚ö†Ô∏è PIN4 absent. V√©rifie ton t√©l√©phone session.", "bad");

    const clean = validateLinks(LINKS);
    if(!clean.length){
      show("‚ö†Ô∏è Aucun lien valide √† enregistrer. (Label + URL obligatoires)", "warn");
      return;
    }

    $("btnSave").disabled = true;
    show("‚è≥ Enregistrement‚Ä¶", "warn");

    try{
      const { data, error } = await sb.rpc("digiy_go_links_save", {
        p_slug: slug,
        p_phone: phone,
        p_pin4: pin4,
        p_links: clean
      });

      if(error) return show("‚ùå Erreur: " + (error.message || error), "bad");
      if(!data?.ok) return show("‚ùå Refus√©: " + (data?.error || "unknown"), "bad");

      // Remet la version clean (normalis√©e)
      LINKS = clean;
      render();

      show("‚úÖ Enregistr√© (" + (data.count ?? clean.length) + " lien(s)).", "ok");

    }catch(e){
      console.error(e);
      show("‚ùå Crash save: " + String(e?.message||e), "bad");
    }finally{
      $("btnSave").disabled = false;
    }
  }

  // =========================
  // UI events
  // =========================
  $("btnAdd").addEventListener("click", ()=>{
    LINKS.push({ order: nextOrder(), label:"WhatsApp", url:"https://wa.me/221XXXXXXXXX", active:true });
    render();
    show("‚úÖ Nouveau lien ajout√© (pense √† Enregistrer).", "ok");
  });

  $("btnSort").addEventListener("click", ()=>{
    LINKS = validateLinks(LINKS);
    render();
    show("‚úÖ Tri + nettoyage appliqu√©s (pense √† Enregistrer).", "ok");
  });

  $("btnReset").addEventListener("click", ()=>{
    if(!confirm("Vider la liste ?")) return;
    LINKS = [];
    render();
    show("Liste vid√©e. Clique Enregistrer pour appliquer.", "warn");
  });

  $("btnLoad").addEventListener("click", loadLinks);
  $("btnSave").addEventListener("click", saveLinks);

  // =========================
  // INIT session banner
  // =========================
  const sess = window.DIGIY_GUARD?.getSession?.() || null;
  const phone = normPhone(sess?.phone || "");
  $("pillStatus").textContent = sess?.ok ? "Connect√© ‚úÖ" : "Non connect√© ‚ùå";
  $("who").textContent = sess?.ok
    ? ("T√©l√©phone: " + phone + " ¬∑ PIN auto: " + pin4FromPhone(phone) + " ¬∑ (PIN4 = contr√¥le rapide, pas un secret)")
    : "Session absente. Retourne sur PIN et reconnecte-toi.";

  render();

  if(!slug) show("‚ùå slug manquant. Ouvre depuis le cockpit.", "bad");
  else if(!sess?.ok) show("‚ùå Session manquante. Reconnecte-toi via PIN.", "bad");
  else {
    show("‚úÖ Pr√™t. Chargement auto‚Ä¶", "ok");
    loadLinks();
  }
})();
</script>
</body>
</html>
