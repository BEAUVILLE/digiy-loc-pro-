<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>GO PIN ‚Äî Manage Links</title>
  <meta name="theme-color" content="#16a34a" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.78);
      --green:#16a34a; --gold:#facc15; --radius:18px;
      --danger:#ff5c5c;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:radial-gradient(900px 500px at 10% -10%, rgba(34,197,94,.20), transparent 60%),
                 radial-gradient(900px 500px at 110% 0%, rgba(250,204,21,.10), transparent 55%),
                 var(--bg);
      color:var(--text);
      padding:18px;
    }
    .wrap{max-width:980px;margin:0 auto}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .brand h1{margin:0;font-size:18px;letter-spacing:.5px}
    .badge{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:6px 10px;border-radius:999px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    label{display:block;margin:10px 0 6px;color:var(--muted);font-size:12px}
    input, select{
      width:100%;padding:12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:var(--text);outline:none
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      padding:12px 14px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.03); color:var(--text); text-decoration:none;
      font-weight:850; cursor:pointer;
    }
    .btn.primary{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.12)}
    .btn.gold{border-color:rgba(250,204,21,.30); background:rgba(250,204,21,.10)}
    .btn.danger{border-color:rgba(255,92,92,.35); background:rgba(255,92,92,.10)}
    .btn.small{padding:9px 10px;border-radius:12px;font-weight:850}
    .muted{color:var(--muted);font-size:12px;line-height:1.35}
    .err{display:none;color:#ffd2d2;background:rgba(255,0,0,.10);border:1px solid rgba(255,0,0,.22);padding:12px;border-radius:14px;margin-top:10px}
    .ok{display:none;color:#d6ffe2;background:rgba(34,197,94,.10);border:1px solid rgba(34,197,94,.22);padding:12px;border-radius:14px;margin-top:10px}
    .divider{height:1px;background:var(--line);margin:14px 0}
    .list{display:grid;gap:10px;margin-top:10px}
    .item{
      border:1px solid var(--line); border-radius:16px; padding:12px;
      background:rgba(0,0,0,.18);
      display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:start;
    }
    .item h3{margin:0;font-size:14px}
    .item .url{margin:6px 0 0;color:var(--muted);font-size:12px;word-break:break-all}
    .k{display:inline-flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .pill{font-size:11px;color:var(--muted);border:1px solid var(--line);padding:4px 8px;border-radius:999px}
    .right{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .copy{
      user-select:all;background:rgba(250,204,21,.10);border:1px solid rgba(250,204,21,.22);
      padding:10px;border-radius:14px;color:var(--text);font-size:12px
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>DIGIY ‚ôæÔ∏è ‚Äî GO PIN</h1>
        <div class="badge">Manage Links</div>
      </div>
      <div class="row">
        <button class="btn small" id="btn_logout" style="display:none">Se d√©connecter</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Auth + Select PIN -->
      <div class="card">
        <h2 style="margin:0 0 6px;font-size:16px">Connexion</h2>
        <div class="muted">
          Tu peux te connecter en <b>email+mot de passe</b>, ou demander un <b>magic link</b>.
        </div>

        <div class="divider"></div>

        <div id="auth_box">
          <label>Email</label>
          <input id="email" type="email" placeholder="pro@digiylyfe.com" autocomplete="email" />

          <label>Mot de passe (optionnel si magic link)</label>
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />

          <div class="row" style="margin-top:12px">
            <button class="btn primary" id="btn_login">Login</button>
            <button class="btn" id="btn_magic">Envoyer Magic Link</button>
          </div>

          <div class="muted" style="margin-top:10px">
            ‚ö†Ô∏è Le owner ne voit que <b>ses</b> PINs (RLS).
          </div>
        </div>

        <div id="user_box" style="display:none">
          <div class="muted">Connect√© en tant que :</div>
          <div class="mono" id="user_email" style="margin-top:6px"></div>

          <div class="divider"></div>

          <h2 style="margin:0 0 6px;font-size:16px">Choisir un GO PIN</h2>
          <label>Mes PINs</label>
          <select id="pin_select"></select>

          <div id="pin_info" style="display:none;margin-top:12px">
            <div class="muted">PIN</div>
            <div class="copy mono" id="pin_code"></div>

            <div class="muted" style="margin-top:10px">Lien public</div>
            <div class="copy mono" id="public_link"></div>

            <div class="row" style="margin-top:10px">
              <a class="btn gold" id="btn_open_pin" href="#" target="_blank" rel="nofollow">Ouvrir page publique</a>
              <button class="btn" id="btn_copy_link">Copier lien</button>
            </div>
          </div>
        </div>

        <div class="err" id="auth_err"></div>
        <div class="ok" id="auth_ok"></div>
      </div>

      <!-- RIGHT: Add/Edit Links -->
      <div class="card">
        <h2 style="margin:0 0 6px;font-size:16px">GO LINKS</h2>
        <div class="muted">Ajoute les boutons ‚ÄúCommander / R√©server / Demander course / etc.‚Äù</div>

        <div class="divider"></div>

        <div id="link_form" style="opacity:.5;pointer-events:none">
          <input type="hidden" id="link_id" value="" />

          <label>Label</label>
          <input id="link_label" placeholder="Commander / R√©server / Voir catalogue" />

          <label>URL</label>
          <input id="link_url" placeholder="https://..." />

          <div class="row">
            <div style="flex:1;min-width:220px">
              <label>Ordre (petit = en haut)</label>
              <input id="link_sort" type="number" value="100" />
            </div>
            <div style="flex:1;min-width:220px">
              <label>Actif</label>
              <select id="link_active">
                <option value="true" selected>Oui</option>
                <option value="false">Non</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button class="btn primary" id="btn_save_link">Enregistrer</button>
            <button class="btn" id="btn_reset_form">Nouveau</button>
          </div>

          <div class="err" id="link_err"></div>
          <div class="ok" id="link_ok"></div>

          <div class="divider"></div>

          <h3 style="margin:0 0 10px;font-size:14px;color:var(--muted)">Liste des liens</h3>
          <div class="list" id="links_list"></div>
        </div>

        <div class="muted" id="hint_choose_pin">
          üëâ Connecte-toi puis choisis un PIN pour g√©rer ses liens.
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  "use strict";

  // ‚úÖ Tes variables Supabase (int√©gr√©es)
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id)=>document.getElementById(id);

  let currentUser = null;
  let currentPin = null; // {id, slug, pin_code, title}
  let currentLinks = [];

  function show(el, yes){ el.style.display = yes ? "block" : "none"; }
  function setText(el, t){ el.textContent = t || ""; }

  function msgOK(boxId, text){
    const el = $(boxId);
    el.className = "ok";
    setText(el, text);
    show(el, true);
    setTimeout(()=>show(el,false), 2200);
  }
  function msgERR(boxId, text){
    const el = $(boxId);
    el.className = "err";
    setText(el, text);
    show(el, true);
  }

  function clearMsgs(){
    show($("auth_err"), false);
    show($("link_err"), false);
    show($("auth_ok"), false);
    show($("link_ok"), false);
  }

  function baseUrlForPublic(){
    // On suppose que pin.html est dans le m√™me dossier
    return location.href.replace(/manage-links\.html.*$/,'');
  }

  function buildPublicLink(slug){
    return baseUrlForPublic() + "pin.html?slug=" + encodeURIComponent(slug);
  }

  function setFormEnabled(enabled){
    $("link_form").style.opacity = enabled ? "1" : ".5";
    $("link_form").style.pointerEvents = enabled ? "auto" : "none";
    show($("hint_choose_pin"), !enabled);
  }

  function resetForm(){
    $("link_id").value = "";
    $("link_label").value = "";
    $("link_url").value = "";
    $("link_sort").value = "100";
    $("link_active").value = "true";
    show($("link_err"), false);
    show($("link_ok"), false);
  }

  function isSafeHttpUrl(url){
    try{
      const u = new URL(url);
      return (u.protocol === "https:" || u.protocol === "http:");
    }catch(e){
      return false;
    }
  }

  async function refreshSession(){
    const { data } = await sb.auth.getSession();
    currentUser = data?.session?.user || null;

    if(currentUser){
      show($("auth_box"), false);
      show($("user_box"), true);
      show($("btn_logout"), true);
      setText($("user_email"), currentUser.email || currentUser.id);

      await loadMyPins();
    }else{
      show($("auth_box"), true);
      show($("user_box"), false);
      show($("btn_logout"), false);
      setFormEnabled(false);
      $("pin_select").innerHTML = "";
      currentPin = null;
    }
  }

  async function loadMyPins(){
    // RLS: ne retourne que les pins du owner
    const { data, error } = await sb
      .from("go_pins")
      .select("id, slug, pin_code, title")
      .order("created_at", { ascending: false });

    if(error){
      msgERR("auth_err", "Erreur chargement PINs: " + error.message);
      return;
    }

    const sel = $("pin_select");
    sel.innerHTML = "";

    if(!data || data.length === 0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Aucun PIN (cr√©e-en un via create-pin.html)";
      sel.appendChild(opt);
      currentPin = null;
      setFormEnabled(false);
      show($("pin_info"), false);
      return;
    }

    data.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = `${p.pin_code} ‚Äî ${p.title}`;
      opt.dataset.slug = p.slug;
      opt.dataset.pin_code = p.pin_code;
      opt.dataset.title = p.title;
      sel.appendChild(opt);
    });

    // Auto select first
    sel.value = data[0].id;
    await onSelectPin();
  }

  async function onSelectPin(){
    clearMsgs();
    const sel = $("pin_select");
    const opt = sel.options[sel.selectedIndex];
    const pinId = sel.value;

    if(!pinId){
      currentPin = null;
      setFormEnabled(false);
      show($("pin_info"), false);
      return;
    }

    currentPin = {
      id: pinId,
      slug: opt.dataset.slug,
      pin_code: opt.dataset.pin_code,
      title: opt.dataset.title
    };

    // Info lien public
    show($("pin_info"), true);
    setText($("pin_code"), currentPin.pin_code);
    const link = buildPublicLink(currentPin.slug);
    setText($("public_link"), link);
    $("btn_open_pin").href = link;

    setFormEnabled(true);
    resetForm();
    await loadLinks();
  }

  async function loadLinks(){
    if(!currentPin) return;

    const { data, error } = await sb
      .from("go_pin_links")
      .select("id, pin_id, label, url, sort_order, is_active, created_at")
      .eq("pin_id", currentPin.id)
      .order("sort_order", { ascending: true });

    if(error){
      msgERR("link_err", "Erreur chargement liens: " + error.message);
      return;
    }

    currentLinks = data || [];
    renderLinks();
  }

  function renderLinks(){
    const box = $("links_list");
    box.innerHTML = "";

    if(!currentLinks.length){
      const div = document.createElement("div");
      div.className = "muted";
      div.textContent = "Aucun lien. Ajoute le premier et √ßa va respirer.";
      box.appendChild(div);
      return;
    }

    currentLinks.forEach((l, idx)=>{
      const item = document.createElement("div");
      item.className = "item";

      const left = document.createElement("div");
      const h3 = document.createElement("h3");
      h3.textContent = l.label + (l.is_active ? "" : " (inactif)");
      const url = document.createElement("div");
      url.className = "url";
      url.textContent = l.url;

      const k = document.createElement("div");
      k.className = "k";
      const p1 = document.createElement("span");
      p1.className = "pill";
      p1.textContent = "ordre: " + (l.sort_order ?? 100);
      const p2 = document.createElement("span");
      p2.className = "pill";
      p2.textContent = l.is_active ? "actif" : "off";

      k.appendChild(p1); k.appendChild(p2);

      left.appendChild(h3);
      left.appendChild(url);
      left.appendChild(k);

      const right = document.createElement("div");
      right.className = "right";

      const up = document.createElement("button");
      up.className = "btn small";
      up.textContent = "‚Üë";
      up.disabled = (idx === 0);
      up.addEventListener("click", ()=> moveLink(idx, -1));

      const down = document.createElement("button");
      down.className = "btn small";
      down.textContent = "‚Üì";
      down.disabled = (idx === currentLinks.length - 1);
      down.addEventListener("click", ()=> moveLink(idx, +1));

      const edit = document.createElement("button");
      edit.className = "btn small gold";
      edit.textContent = "√âditer";
      edit.addEventListener("click", ()=> fillFormForEdit(l));

      const open = document.createElement("a");
      open.className = "btn small";
      open.textContent = "Ouvrir";
      open.href = l.url;
      open.target = "_blank";
      open.rel = "nofollow";

      const del = document.createElement("button");
      del.className = "btn small danger";
      del.textContent = "Suppr";
      del.addEventListener("click", ()=> deleteLink(l));

      right.appendChild(up);
      right.appendChild(down);
      right.appendChild(edit);
      right.appendChild(open);
      right.appendChild(del);

      item.appendChild(left);
      item.appendChild(right);

      box.appendChild(item);
    });
  }

  function fillFormForEdit(l){
    $("link_id").value = l.id;
    $("link_label").value = l.label || "";
    $("link_url").value = l.url || "";
    $("link_sort").value = String(l.sort_order ?? 100);
    $("link_active").value = String(!!l.is_active);
    msgOK("link_ok", "Mode √©dition ‚úÖ");
  }

  async function saveLink(){
    clearMsgs();
    if(!currentPin) return msgERR("link_err", "Choisis un PIN d‚Äôabord.");

    const linkId = $("link_id").value.trim() || null;
    const label = $("link_label").value.trim();
    const url = $("link_url").value.trim();
    const sort = Number($("link_sort").value);
    const active = ($("link_active").value === "true");

    if(!label) return msgERR("link_err", "Label obligatoire.");
    if(!url) return msgERR("link_err", "URL obligatoire.");
    if(!isSafeHttpUrl(url)) return msgERR("link_err", "URL invalide (http/https uniquement).");
    if(!Number.isFinite(sort)) return msgERR("link_err", "Sort order invalide.");

    const { data, error } = await sb.rpc("upsert_go_pin_link", {
      p_pin_id: currentPin.id,
      p_link_id: linkId,
      p_label: label,
      p_url: url,
      p_sort_order: sort,
      p_is_active: active
    });

    if(error){
      msgERR("link_err", "Erreur save: " + error.message);
      return;
    }

    msgOK("link_ok", "Lien enregistr√© ‚úÖ");
    resetForm();
    await loadLinks();
  }

  async function deleteLink(l){
    clearMsgs();
    if(!confirm("Supprimer ce lien ?")) return;

    const { error } = await sb.rpc("delete_go_pin_link", { p_link_id: l.id });
    if(error){
      msgERR("link_err", "Erreur delete: " + error.message);
      return;
    }

    msgOK("link_ok", "Lien supprim√© ‚úÖ");
    await loadLinks();
  }

  async function moveLink(index, delta){
    clearMsgs();
    if(!currentPin) return;

    const a = currentLinks[index];
    const b = currentLinks[index + delta];
    if(!a || !b) return;

    // swap sort_order (si √©gal, on force des valeurs proches)
    let sa = Number(a.sort_order ?? 100);
    let sbv = Number(b.sort_order ?? 100);
    if(sa === sbv){
      sa = sa + (delta > 0 ? -1 : +1);
    }

    // On update via RPC upsert (RLS owner)
    const r1 = await sb.rpc("upsert_go_pin_link", {
      p_pin_id: currentPin.id, p_link_id: a.id,
      p_label: a.label, p_url: a.url,
      p_sort_order: sbv, p_is_active: !!a.is_active
    });
    if(r1.error) return msgERR("link_err", "Erreur tri: " + r1.error.message);

    const r2 = await sb.rpc("upsert_go_pin_link", {
      p_pin_id: currentPin.id, p_link_id: b.id,
      p_label: b.label, p_url: b.url,
      p_sort_order: sa, p_is_active: !!b.is_active
    });
    if(r2.error) return msgERR("link_err", "Erreur tri: " + r2.error.message);

    msgOK("link_ok", "Ordre mis √† jour ‚úÖ");
    await loadLinks();
  }

  async function loginEmailPassword(){
    clearMsgs();
    const email = $("email").value.trim();
    const password = $("password").value;

    if(!email) return msgERR("auth_err", "Email obligatoire.");
    if(!password) return msgERR("auth_err", "Mot de passe obligatoire pour Login.");

    const { error } = await sb.auth.signInWithPassword({ email, password });
    if(error){
      msgERR("auth_err", "Login KO: " + error.message);
      return;
    }
    msgOK("auth_ok", "Connect√© ‚úÖ");
    await refreshSession();
  }

  async function sendMagicLink(){
    clearMsgs();
    const email = $("email").value.trim();
    if(!email) return msgERR("auth_err", "Email obligatoire.");

    // redirect back to this page after click
    const redirectTo = location.href.split('#')[0];

    const { error } = await sb.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: redirectTo }
    });

    if(error){
      msgERR("auth_err", "Magic link KO: " + error.message);
      return;
    }
    msgOK("auth_ok", "Magic link envoy√© ‚úÖ (check ta bo√Æte mail)");
  }

  async function logout(){
    await sb.auth.signOut();
    msgOK("auth_ok", "D√©connect√© ‚úÖ");
    await refreshSession();
  }

  async function copyPublicLink(){
    if(!currentPin) return;
    const link = buildPublicLink(currentPin.slug);
    try{
      await navigator.clipboard.writeText(link);
      msgOK("auth_ok", "Lien copi√© ‚úÖ");
    }catch(e){
      // fallback
      prompt("Copie le lien :", link);
    }
  }

  // Events
  $("btn_login").addEventListener("click", loginEmailPassword);
  $("btn_magic").addEventListener("click", sendMagicLink);
  $("btn_logout").addEventListener("click", logout);
  $("pin_select").addEventListener("change", onSelectPin);

  $("btn_save_link").addEventListener("click", saveLink);
  $("btn_reset_form").addEventListener("click", resetForm);
  $("btn_copy_link").addEventListener("click", copyPublicLink);

  // Auto refresh on auth change
  sb.auth.onAuthStateChange(async ()=>{
    await refreshSession();
  });

  // Init
  refreshSession();
})();
</script>
</body>
</html>
