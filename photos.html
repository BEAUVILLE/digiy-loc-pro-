<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DIGIY LOC PRO ‚Äî Photos</title>

  <!-- UI GLOBAL DIGIY -->
  <link rel="stylesheet" href="ui.css" />

  <!-- Supabase + Guard -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./guard.js?v=locpro-photos-phase1"></script>

  <style>
    .top-nav{
      display:flex; gap:12px;
      padding:12px 16px;
      background:var(--bg, #022c22);
      border-bottom:1px solid rgba(250,204,21,0.2);
      flex-wrap:wrap;
    }
    .top-nav a{color:var(--text,#e5e7eb); text-decoration:none; font-weight:700; font-size:.92rem}
    .top-nav a.active{color:var(--accent,#facc15)}
    .top-nav .right{
      margin-left:auto;
      display:flex; gap:10px; align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      font-size:.78rem;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(250,204,21,0.28);
      color:var(--text,#e5e7eb);
      background:rgba(15,23,42,0.25);
    }

    .medias-page{padding:16px; max-width:640px; margin:auto; color:var(--text,#e5e7eb)}
    .page-header h1{font-size:1.35rem; margin:0 0 6px}
    .page-header p{margin:0; color:var(--muted,#9ca3af); font-size:.95rem}

    .card{
      background:var(--card,#052e16);
      border-radius:14px;
      padding:16px;
      margin-top:16px;
      border:1px solid rgba(250,204,21,0.18);
    }
    .card.highlight{background:linear-gradient(135deg,var(--bg,#022c22),var(--bg2,#065f46))}
    h2{margin:0 0 10px; font-size:1.05rem}
    .hint{margin:0 0 12px; color:#e5e7eb; font-size:.9rem; line-height:1.35}

    .btn{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:none;
      font-weight:800;
      font-size:.95rem;
      cursor:pointer;
    }
    .btn-primary{background:var(--accent,#facc15); color:#022c22}
    .btn-secondary{background:#16a34a; color:#fff}
    .btn-ghost{
      background:transparent;
      border:1px solid rgba(250,204,21,0.35);
      color:var(--text,#e5e7eb);
      margin-top:10px;
    }

    /* Champs */
    .field{margin-top:10px}
    .field label{display:block; font-weight:800; margin-bottom:6px; font-size:.9rem}
    .field input, .field textarea{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.35);
      background:rgba(15,23,42,0.5);
      color:var(--text,#e5e7eb);
      outline:none;
    }
    .field textarea{min-height:120px; resize:vertical}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .row .btn{flex:1}

    /* Galerie */
    .toolbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .toolbar .btn{flex:1}
    .gallery{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
      margin-top:12px;
    }
    .tile{
      position:relative;
      border-radius:12px;
      overflow:hidden;
      background:var(--bg,#022c22);
      aspect-ratio:1/1;
      border:1px solid rgba(250,204,21,0.14);
    }
    .tile img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .tile .empty{
      width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
      font-size:1.6rem; color:var(--accent,#facc15);
      font-weight:900;
    }
    .badge{
      position:absolute;
      left:8px; top:8px;
      background:rgba(2,44,34,0.75);
      border:1px solid rgba(250,204,21,0.35);
      color:#fff;
      padding:4px 8px;
      border-radius:999px;
      font-size:.72rem;
      font-weight:800;
      backdrop-filter: blur(6px);
    }
    .actions{
      position:absolute;
      right:8px; top:8px;
      display:flex; gap:6px;
    }
    .iconbtn{
      width:34px; height:34px;
      border-radius:10px;
      border:none;
      background:rgba(15,23,42,0.7);
      color:#fff;
      cursor:pointer;
      font-weight:900;
    }
    .iconbtn:hover{filter:brightness(1.1)}
    .tile-footer{
      position:absolute; left:0; right:0; bottom:0;
      display:flex; gap:8px;
      padding:8px;
      background:linear-gradient(180deg, transparent, rgba(0,0,0,.65));
      align-items:center;
      justify-content:space-between;
    }
    .smallbtn{
      border:none; cursor:pointer;
      background:rgba(250,204,21,0.95);
      color:#022c22;
      font-weight:900;
      font-size:.72rem;
      padding:7px 10px;
      border-radius:10px;
      white-space:nowrap;
    }
    .smallbtn.secondary{
      background:rgba(255,255,255,0.12);
      color:#fff;
      border:1px solid rgba(255,255,255,0.15);
    }

    .note{
      margin-top:10px;
      color:var(--muted,#9ca3af);
      font-size:.85rem;
      line-height:1.35;
    }

    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.22);
      background:rgba(15,23,42,0.35);
      color:#e5e7eb;
      font-size:.9rem;
      line-height:1.35;
    }
    .status.ok{border-color:rgba(34,197,94,.35)}
    .status.bad{border-color:rgba(251,113,133,.45)}
    .status small{color:var(--muted,#9ca3af)}
    code.k{font-weight:900;color:var(--accent,#facc15)}
  </style>
</head>

<body>

  <nav class="top-nav">
    <a href="dashboard.html">üè† Accueil</a>
    <a href="planning.html">üìÖ Planning</a>
    <a href="reservations.html">üßæ R√©servations</a>
    <a href="encaissements.html">üí∞ Encaissements</a>
    <a href="photos.html" class="active">üñºÔ∏è Photos</a>

    <div class="right">
      <span class="pill" id="pillSlug">slug: ‚Äî</span>
      <button class="btn btn-ghost" style="width:auto;padding:10px 12px;margin-top:0" id="btnReload">‚Üª Recharger</button>
      <button class="btn btn-primary" style="width:auto;padding:10px 12px;margin-top:0" id="btnSave">üíæ Enregistrer</button>
    </div>
  </nav>

  <main class="medias-page">

    <header class="page-header">
      <h1>üñºÔ∏è Photos logement</h1>
      <p>Phase 1 : on stocke seulement des <b>URLs</b> (WordPress Media / Cloudinary / etc.). L√©ger. Pro. Terrain.</p>
    </header>

    <!-- PHOTOS -->
    <section class="card">
      <h2>üì∏ Galerie</h2>
      <p class="hint">
        Colle des URLs (HTTPS). Si tu n‚Äôas pas d‚ÄôURL : envoie sur WhatsApp DIGIY, on te renvoie les liens WordPress officiels.
      </p>

      <div class="field">
        <label>Photo principale (cover_url)</label>
        <input id="coverUrl" type="text" placeholder="https://... (URL officielle)" />
      </div>

      <div class="field">
        <label>Ajouter des photos (1 URL par ligne ‚Äî max 12)</label>
        <textarea id="addUrls" placeholder="https://...
https://...
https://..."></textarea>
      </div>

      <div class="toolbar">
        <button class="btn btn-secondary" id="btnAddUrls">‚ûï Ajouter ces URLs √† la galerie</button>
        <button class="btn btn-ghost" id="btnClear">üßπ Vider la galerie</button>
      </div>

      <div class="status" id="statusBox">
        <div><b>√âtat</b> : pr√™t.</div>
        <small>Astuce : la galerie affiche ce que tu vas sauver dans Supabase (URLs only).</small>
      </div>

      <div class="gallery" id="gallery"></div>

      <p class="note">
        ‚úÖ Cache offline : on garde une copie l√©g√®re (URLs) en LocalStorage si le r√©seau saute.
        <br>‚õîÔ∏è On ne stocke jamais les images (pas de base64).
      </p>
    </section>

    <!-- WHATSAPP (fallback terrain) -->
    <section class="card highlight">
      <h2>üì≤ Fallback terrain (WhatsApp ‚Üí WordPress Media)</h2>
      <p class="hint">
        Si tu gal√®res avec les liens : envoie tes photos sur WhatsApp, DIGIY les upload en WordPress Media et te renvoie les URLs officielles.
      </p>

      <div class="row">
        <button class="btn btn-secondary" id="btnWA">üì≤ Envoyer des photos sur WhatsApp DIGIY</button>
        <button class="btn btn-ghost" id="btnPasteHelp">üìå Comment r√©cup√©rer une URL WordPress</button>
      </div>

      <div class="note" id="helpBox" style="display:none">
        <b>Proc√©dure rapide :</b>
        <ol style="margin:8px 0 0 18px; color:#e5e7eb; font-size:.9rem; line-height:1.4">
          <li>DIGIY upload la photo dans WordPress Media</li>
          <li>On copie le lien direct du fichier (HTTPS)</li>
          <li>Tu colles ici : cover + galerie</li>
        </ol>
      </div>
    </section>

  </main>

  <script>
    (() => {
      "use strict";

      // ‚úÖ SUPABASE (d√©j√† int√©gr√©)
      const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2i";

      const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ====== Helpers ======
      const $ = (id) => document.getElementById(id);
      const qs = new URL(location.href).searchParams;
      const slug = (qs.get("slug") || "").trim();

      const LS_KEY = (s) => `digiy_loc_pro_photos_phase1_${s}`;

      function setStatus(text, ok=true){
        const box = $("statusBox");
        box.className = "status " + (ok ? "ok" : "bad");
        box.innerHTML = `<div><b>${ok ? "‚úÖ" : "‚ùå"} ${text}</b></div>
          <small>slug: <code class="k">${escapeHtml(slug || "‚Äî")}</code></small>`;
      }

      function escapeHtml(str){
        return (str||"").replace(/[&<>"']/g, (m) => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
        }[m]));
      }

      function isHttps(u){
        u = (u||"").trim();
        return /^https:\/\/.+/i.test(u);
      }

      function uniqPush(arr, u){
        if(!arr.includes(u)) arr.push(u);
      }

      function parseLines(text){
        const out = [];
        (text||"").split("\n").map(s => (s||"").trim()).forEach(u => {
          if(isHttps(u)) uniqPush(out, u);
        });
        return out;
      }

      function getOwnerIdFromSession(){
        const raw = localStorage.getItem("DIGIY_LOC_PRO_SESSION_V1");
        try{
          const s = JSON.parse(raw||"{}");
          return (s.owner_id || "").trim();
        }catch(e){
          return "";
        }
      }

      // ====== State (URLs only) ======
      let state = {
        cover_url: "",
        gallery_urls: [],
        coverIndex: 0
      };

      function saveCache(){
        if(!slug) return;
        localStorage.setItem(LS_KEY(slug), JSON.stringify(state));
      }

      function loadCache(){
        if(!slug) return null;
        try{
          return JSON.parse(localStorage.getItem(LS_KEY(slug)) || "null");
        }catch(e){
          return null;
        }
      }

      // ====== Render gallery ======
      function render(){
        const galleryEl = $("gallery");
        galleryEl.innerHTML = "";

        const urls = Array.isArray(state.gallery_urls) ? state.gallery_urls.slice(0, 12) : [];
        if(!urls.length){
          for(let i=0;i<3;i++){
            const tile = document.createElement("div");
            tile.className = "tile";
            tile.innerHTML = `<div class="empty">+</div>`;
            tile.addEventListener("click", () => $("addUrls").focus());
            galleryEl.appendChild(tile);
          }
          return;
        }

        urls.forEach((src, idx) => {
          const tile = document.createElement("div");
          tile.className = "tile";

          const isCover = idx === (state.coverIndex ?? 0);

          tile.innerHTML = `
            ${isCover ? `<div class="badge">Photo principale</div>` : ``}
            <div class="actions">
              <button class="iconbtn" title="Supprimer" data-del="${idx}">‚úï</button>
            </div>
            <img loading="lazy" decoding="async" src="${src}" alt="Photo ${idx+1}" onerror="this.style.opacity=.25">
            <div class="tile-footer">
              <button class="smallbtn" data-cover="${idx}">‚òÖ Principal</button>
              <button class="smallbtn secondary" data-moveleft="${idx}">‚Üê</button>
              <button class="smallbtn secondary" data-moveright="${idx}">‚Üí</button>
            </div>
          `;

          galleryEl.appendChild(tile);
        });

        // bind actions
        galleryEl.querySelectorAll("[data-del]").forEach(b=>{
          b.addEventListener("click", (e)=>{
            e.stopPropagation();
            const i = Number(b.getAttribute("data-del"));
            state.gallery_urls.splice(i,1);
            if(state.coverIndex >= state.gallery_urls.length) state.coverIndex = 0;
            // Sync coverUrl input if cover was deleted
            if(state.cover_url && !isHttps(state.cover_url)) state.cover_url = "";
            saveCache(); render();
            setStatus("Galerie mise √† jour (non enregistr√©e).");
          });
        });

        galleryEl.querySelectorAll("[data-cover]").forEach(b=>{
          b.addEventListener("click",(e)=>{
            e.stopPropagation();
            state.coverIndex = Number(b.getAttribute("data-cover"));
            // Auto: cover_url prend l‚ÄôURL s√©lectionn√©e
            state.cover_url = state.gallery_urls[state.coverIndex] || "";
            $("coverUrl").value = state.cover_url;
            saveCache(); render();
            setStatus("Cover s√©lectionn√©e (non enregistr√©e).");
          });
        });

        galleryEl.querySelectorAll("[data-moveleft]").forEach(b=>{
          b.addEventListener("click",(e)=>{
            e.stopPropagation();
            const i = Number(b.getAttribute("data-moveleft"));
            if(i<=0) return;
            const tmp = state.gallery_urls[i-1];
            state.gallery_urls[i-1] = state.gallery_urls[i];
            state.gallery_urls[i] = tmp;

            if(state.coverIndex === i) state.coverIndex = i-1;
            else if(state.coverIndex === i-1) state.coverIndex = i;

            // refresh cover_url from index
            state.cover_url = state.gallery_urls[state.coverIndex] || state.cover_url;
            $("coverUrl").value = state.cover_url;

            saveCache(); render();
            setStatus("Ordre modifi√© (non enregistr√©).");
          });
        });

        galleryEl.querySelectorAll("[data-moveright]").forEach(b=>{
          b.addEventListener("click",(e)=>{
            e.stopPropagation();
            const i = Number(b.getAttribute("data-moveright"));
            if(i>=state.gallery_urls.length-1) return;
            const tmp = state.gallery_urls[i+1];
            state.gallery_urls[i+1] = state.gallery_urls[i];
            state.gallery_urls[i] = tmp;

            if(state.coverIndex === i) state.coverIndex = i+1;
            else if(state.coverIndex === i+1) state.coverIndex = i;

            state.cover_url = state.gallery_urls[state.coverIndex] || state.cover_url;
            $("coverUrl").value = state.cover_url;

            saveCache(); render();
            setStatus("Ordre modifi√© (non enregistr√©).");
          });
        });
      }

      // ====== Load from Supabase (RPC) ======
      async function loadFromSupabase(){
        if(!slug){
          setStatus("Slug manquant. Exemple: photos.html?slug=chez-astou-saly", false);
          return;
        }

        $("pillSlug").textContent = "slug: " + slug;

        setStatus("Chargement Supabase‚Ä¶");
        const { data, error } = await sb.rpc("digiy_loc_get_photos_by_slug", { p_slug: slug });

        if(error){
          // fallback cache
          const cached = loadCache();
          if(cached){
            state = cached;
            $("coverUrl").value = state.cover_url || "";
            setStatus("Supabase indisponible. Cache offline charg√©.", false);
            render();
            return;
          }
          setStatus("Erreur RPC GET: " + error.message, false);
          return;
        }

        const row = Array.isArray(data) ? data[0] : data;
        const cover = isHttps(row?.cover_url) ? row.cover_url.trim() : "";
        const gallery = Array.isArray(row?.gallery_urls) ? row.gallery_urls.filter(isHttps).slice(0, 12) : [];

        state.cover_url = cover;
        state.gallery_urls = gallery;

        // coverIndex = index dans la galerie si cover existe, sinon 0
        const idx = cover ? gallery.indexOf(cover) : -1;
        state.coverIndex = idx >= 0 ? idx : 0;

        $("coverUrl").value = state.cover_url || "";
        saveCache();
        render();
        setStatus("Charg√© depuis Supabase.");
      }

      // ====== Save to Supabase (RPC) ======
      async function saveToSupabase(){
        if(!slug){
          setStatus("Slug manquant. Exemple: photos.html?slug=chez-astou-saly", false);
          return;
        }

        const ownerId = getOwnerIdFromSession();
        if(!ownerId){
          setStatus("Session PRO absente (owner_id). Reconnecte-toi via GO PIN.", false);
          return;
        }

        // read inputs
        const cover = isHttps($("coverUrl").value) ? $("coverUrl").value.trim() : "";
        // keep gallery max 12 and only https
        const gallery = (Array.isArray(state.gallery_urls) ? state.gallery_urls : []).filter(isHttps).slice(0, 12);

        // If cover is set but not in gallery, push it first
        if(cover && !gallery.includes(cover)){
          gallery.unshift(cover);
        }

        // update state
        state.cover_url = cover;
        state.gallery_urls = gallery;
        state.coverIndex = cover ? Math.max(0, gallery.indexOf(cover)) : 0;

        saveCache();
        render();

        setStatus("Enregistrement Supabase‚Ä¶");
        const { data, error } = await sb.rpc("digiy_loc_set_photos", {
          p_slug: slug,
          p_owner_id: ownerId,
          p_cover_url: cover || null,
          p_gallery_urls: gallery,
          p_media_provider: "wp"
        });

        if(error){
          setStatus("Erreur RPC SAVE: " + error.message, false);
          return;
        }
        if(!data?.ok){
          setStatus("Refus SAVE: " + (data?.reason || "unknown"), false);
          return;
        }

        setStatus("‚úÖ Enregistr√©. Galerie: " + (data.gallery_count || 0));
      }

      // ====== Add URLs to gallery ======
      $("btnAddUrls").addEventListener("click", () => {
        const add = parseLines($("addUrls").value);
        if(!add.length){
          setStatus("Colle au moins une URL HTTPS.", false);
          return;
        }

        if(!Array.isArray(state.gallery_urls)) state.gallery_urls = [];
        add.forEach(u => uniqPush(state.gallery_urls, u));

        // cap 12
        state.gallery_urls = state.gallery_urls.filter(isHttps).slice(0, 12);

        // if no cover_url, set cover to first
        if(!isHttps(state.cover_url) && state.gallery_urls.length){
          state.cover_url = state.gallery_urls[0];
          state.coverIndex = 0;
          $("coverUrl").value = state.cover_url;
        }

        $("addUrls").value = "";
        saveCache();
        render();
        setStatus("URLs ajout√©es (non enregistr√©es).");
      });

      // cover input changes
      $("coverUrl").addEventListener("input", () => {
        const cover = isHttps($("coverUrl").value) ? $("coverUrl").value.trim() : "";
        state.cover_url = cover;
        if(cover && Array.isArray(state.gallery_urls)){
          const idx = state.gallery_urls.indexOf(cover);
          if(idx >= 0) state.coverIndex = idx;
        }
        saveCache();
      });

      // Clear gallery
      $("btnClear").addEventListener("click", () => {
        if(!confirm("Vider la galerie (non enregistr√©) ?")) return;
        state.gallery_urls = [];
        state.cover_url = "";
        state.coverIndex = 0;
        $("coverUrl").value = "";
        $("addUrls").value = "";
        saveCache();
        render();
        setStatus("Galerie vid√©e (non enregistr√©e).");
      });

      // Save / Reload
      $("btnSave").addEventListener("click", saveToSupabase);
      $("btnReload").addEventListener("click", loadFromSupabase);

      // WhatsApp
      $("btnWA").addEventListener("click", () => {
        // Num√©ro support DIGIY (reset PIN / support) d√©j√† connu ‚Äî on l‚Äôutilise en canal terrain
        const phone = "+221771342889";
        const txt = `DIGIY LOC PRO ‚Äî Photos\\nSlug: ${slug || "(√† pr√©ciser)"}\\nBonjour, je vous envoie les photos du logement. Merci de me renvoyer les URLs WordPress Media (HTTPS) pour cover + galerie.`;
        const url = `https://wa.me/${phone.replace("+","")}?text=${encodeURIComponent(txt)}`;
        window.open(url, "_blank");
      });

      $("btnPasteHelp").addEventListener("click", () => {
        const box = $("helpBox");
        box.style.display = (box.style.display === "none" ? "block" : "none");
      });

      // ====== Init ======
      $("pillSlug").textContent = "slug: " + (slug || "‚Äî");

      // Quick guard: if guard exposes a method, you can enforce login here (optional)
      // if(window.DIGIY_GUARD?.requireSession) window.DIGIY_GUARD.requireSession();

      loadFromSupabase();
    })();
  </script>

</body>
</html>
