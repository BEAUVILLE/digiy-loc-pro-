<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>DIGIY LOC PRO ‚Äî Chez Baptiste ‚Ä¢ Planning 14 jours</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <style>
    :root{
      --bg:#020617;
      --card:#030712;
      --accent:#f97316;
      --accent-soft:#fed7aa;
      --green:#16a34a;
      --green-soft:#bbf7d0;
      --line:#1f2937;
      --text:#f9fafb;
      --muted:#9ca3af;
      --danger:#f97373;
      --warn:#facc15;
    }

    *{box-sizing:border-box;margin:0;padding:0;}

    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;
      background:
        radial-gradient(circle at top,#1f2937,transparent 60%),
        radial-gradient(circle at bottom,#0b1120,transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:1.5rem 0.6rem 2rem;
    }

    .page{
      width:100%;
      max-width:1000px;
      background:rgba(9,9,20,0.96);
      border-radius:24px;
      border:1px solid rgba(148,163,184,0.6);
      box-shadow:0 20px 45px rgba(15,23,42,0.9);
      padding:1.6rem 1.2rem 1.8rem;
    }

    @media (min-width:768px){
      body{padding:2.5rem 1.2rem;}
      .page{padding:2.1rem 1.6rem 2.1rem;}
    }

    h1{font-size:1.8rem;margin-bottom:0.3rem;}
    h2{font-size:1.25rem;margin-bottom:0.5rem;}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:0.4rem;
      padding:0.3rem 0.7rem;
      border-radius:999px;
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.14em;
      border:1px solid rgba(250,204,21,0.9);
      background:rgba(251,191,36,0.1);
      color:var(--accent-soft);
      margin-bottom:0.6rem;
    }

    .header-top{
      display:flex;
      gap:1rem;
      align-items:flex-start;
      margin-bottom:1rem;
      flex-wrap:wrap;
    }

    .logo{
      width:58px;height:58px;border-radius:18px;
      background:radial-gradient(circle at 30% 15%,#fef3c7,#22c55e);
      display:flex;align-items:center;justify-content:center;
      font-size:1.8rem;font-weight:900;color:#111827;
      box-shadow:0 14px 30px rgba(34,197,94,0.8);
      flex-shrink:0;
    }

    .subtitle{color:var(--muted);margin-top:0.2rem;line-height:1.5;}
    .tagline{margin-top:0.35rem;color:var(--accent-soft);font-weight:600;}

    .pill-row{display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:0.5rem;}
    .pill{
      padding:0.25rem 0.65rem;border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      font-size:0.8rem;text-transform:uppercase;letter-spacing:0.1em;
      color:var(--muted);
    }
    .pill-strong{
      border-color:rgba(34,197,94,1);
      color:#bbf7d0;
      background:rgba(22,163,74,0.24);
    }

    .topbar{
      margin-top:0.8rem;
      display:flex;
      flex-wrap:wrap;
      gap:0.5rem;
      align-items:center;
      justify-content:space-between;
    }

    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.9);
      color:var(--text);
      padding:0.45rem 0.95rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:0.35rem;
      text-decoration:none;
      user-select:none;
    }
    .btn:hover{border-color:rgba(250,204,21,0.9);}
    .btn-ghost{background:transparent;}
    .btn-accent{
      background:linear-gradient(135deg,#f97316,#ea580c);
      border-color:#fdba74;
      color:#111827;
      font-weight:800;
    }
    .btn-danger{
      border-color:rgba(248,113,113,0.9);
      color:#fee2e2;
    }

    .pro-banner{
      margin-top:0.7rem;
      border-radius:16px;
      padding:0.75rem 0.85rem;
      border:1px solid rgba(148,163,184,0.35);
      background:rgba(255,255,255,0.04);
      color:var(--muted);
      line-height:1.45;
    }
    .pro-banner strong{ color: var(--warn); }
    .pro-banner .ok{ color: var(--green-soft); font-weight:800; }
    .pro-banner .ko{ color: var(--danger); font-weight:800; }

    .planning-header{
      margin-top:1.1rem;
      margin-bottom:0.6rem;
      display:flex;
      flex-direction:column;
      gap:0.4rem;
    }

    .planning-title-main{font-weight:700;}
    .planning-sub{color:var(--muted);}

    .planning-nav{
      margin-top:0.4rem;
      display:flex;
      flex-wrap:wrap;
      gap:0.4rem;
      align-items:center;
      justify-content:space-between;
    }

    .nav-left,.nav-right{display:flex;gap:0.4rem;align-items:center;flex-wrap:wrap;}

    .legend-row{display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:0.4rem;}
    .legend-item{
      display:inline-flex;align-items:center;gap:0.35rem;
      padding:0.25rem 0.6rem;border-radius:999px;
      border:1px solid rgba(55,65,81,0.9);
      font-size:0.85rem;color:var(--muted);
    }
    .legend-color{width:14px;height:14px;border-radius:4px;}
    .legend-libre{background:rgba(22,163,74,0.15);border:1px solid rgba(22,163,74,0.7);}
    .legend-resa{background:rgba(250,204,21,0.2);border:1px solid rgba(250,204,21,0.9);}
    .legend-ota{background:rgba(248,113,113,0.3);border:1px solid rgba(248,113,113,0.9);}
    .legend-ferme{background:rgba(55,65,81,0.8);border:1px solid rgba(55,65,81,1);}

    .table-wrap{
      margin-top:0.8rem;
      overflow-x:auto;
      border-radius:18px;
      border:1px solid rgba(31,41,55,0.95);
      background:linear-gradient(145deg,#020617,#02081a);
    }

    table{border-collapse:collapse;min-width:780px;}
    th,td{border-bottom:1px solid rgba(31,41,55,0.9);padding:0.45rem 0.5rem;text-align:center;vertical-align:middle;}

    thead th{
      position:sticky;top:0;background:#020617;z-index:2;
      font-size:0.9rem;font-weight:700;color:#e5e7eb;white-space:nowrap;
    }
    thead th:first-child{text-align:left;}

    tbody td:first-child{
      text-align:left;font-weight:700;position:sticky;left:0;
      background:linear-gradient(90deg,#020617,#02081a);z-index:1;
    }

    .day-label{display:flex;flex-direction:column;gap:0.1rem;}
    .day-label span:first-child{font-size:0.8rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--muted);}
    .day-label span:last-child{font-size:0.95rem;font-weight:700;}

    .cell-status{border-radius:10px;padding:0.3rem 0.35rem;font-size:0.9rem;}
    .cell-libre{background:rgba(22,163,74,0.18);color:#bbf7d0;border:1px solid rgba(22,163,74,0.7);}
    .cell-resa-digiy{background:rgba(250,204,21,0.25);color:#fef9c3;border:1px solid rgba(250,204,21,0.9);}
    .cell-ota{background:rgba(248,113,113,0.3);color:#fee2e2;border:1px solid rgba(248,113,113,0.95);}
    .cell-ferme{background:rgba(55,65,81,0.9);color:#e5e7eb;border:1px solid rgba(55,65,81,1);}

    .grid-2{
      display:grid;
      grid-template-columns:1.4fr 1.2fr;
      gap:1rem;
      margin-top:1.4rem;
    }
    @media (max-width:768px){ .grid-2{grid-template-columns:1fr;} }

    .card{
      background:linear-gradient(145deg,#020617,#02081a);
      border-radius:18px;
      border:1px solid rgba(31,41,55,0.95);
      padding:0.9rem 0.9rem 1rem;
    }

    label{display:block;margin-bottom:0.2rem;font-size:0.9rem;color:var(--muted);}
    .required::after{content:"*";color:#facc15;margin-left:4px;}

    .field-row{display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.6rem;}
    .field-col{flex:1 1 140px;min-width:0;}

    input, select, textarea{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(55,65,81,0.9);
      background:rgba(15,23,42,0.95);
      color:var(--text);
      padding:0.45rem 0.55rem;
      outline:none;
    }
    textarea{min-height:70px;resize:vertical;}
    input:focus, select:focus, textarea:focus{border-color:rgba(250,204,21,0.9);}

    .hint{font-size:0.85rem;color:var(--muted);margin-top:0.15rem;}

    .status-msg{margin-top:0.4rem;min-height:1.1rem;font-size:0.9rem;}
    .status-error{color:var(--danger);}
    .status-success{color:var(--green-soft);}
    .status-warn{color:var(--warn);}

    .resa-list-empty{color:var(--muted);}
    .resa-item{padding:0.5rem 0;border-bottom:1px dashed rgba(55,65,81,0.9);font-size:0.95rem;}
    .resa-item strong{color:var(--accent-soft);}
    .resa-meta{color:var(--muted);font-size:0.9rem;margin-top:0.15rem;}

    .footer{margin-top:1.2rem;font-size:0.9rem;color:var(--muted);text-align:center;}
    .tiny{font-size:0.85rem;color:var(--muted);}

    .lock{
      opacity:0.55;
      pointer-events:none;
      filter:grayscale(0.35);
    }
  </style>
</head>

<body>
  <main class="page">

    <header class="header">
      <div class="header-top">
        <div class="logo">‚àû</div>
        <div style="flex:1 1 420px;">
          <div class="badge">DIGIY LOC ‚Äî CHEZ BAPTISTE (PRO)</div>
          <h1>Planning propri√©taire ‚Ä¢ Appartement 2 chambres</h1>
          <p class="subtitle">
            0% commission, r√©servation directe avec le propri√©taire.
            <strong>√âcran PRO</strong> : acc√®s r√©serv√© au compte connect√©.
          </p>
          <div class="tagline">
            Planning 14 jours ‚Ä¢ Synchronis√© Supabase DIGIY CORE (business : <strong>chez-baptiste</strong>).
          </div>
          <div class="pill-row">
            <span class="pill pill-strong" id="pillOwner">‚Äî</span>
            <span class="pill">Appartement complet</span>
            <span class="pill">4 personnes max</span>
            <span class="pill" id="pillStatus">statut ‚Äî</span>
          </div>

          <div class="topbar">
            <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
              <a class="btn btn-ghost" id="btnBackHub" href="#">‚Üê Retour au HUB</a>
              <button class="btn btn-ghost" id="btnReload">‚ü≥ Recharger</button>
            </div>
            <button class="btn btn-danger" id="btnLogout">‚èè D√©connexion</button>
          </div>

          <div class="pro-banner" id="proBanner">
            V√©rification du compte‚Ä¶ (<span class="tiny" id="debugLine">‚Äî</span>)
          </div>
        </div>
      </div>
    </header>

    <section class="planning-header">
      <div class="planning-title-main" id="planningTitle">Planning 14 jours</div>
      <div class="planning-sub" id="planningSub">Du ‚Ä¶ au ‚Ä¶</div>

      <div class="planning-nav">
        <div class="nav-left">
          <button class="btn btn-ghost" id="btnPrev">&larr; 14 jours</button>
          <button class="btn btn-ghost" id="btnToday">Aujourd‚Äôhui</button>
          <button class="btn btn-ghost" id="btnNext">14 jours &rarr;</button>
        </div>

        <div class="nav-right">
          <div class="legend-row">
            <div class="legend-item"><span class="legend-color legend-libre"></span> Libre (DIGIY)</div>
            <div class="legend-item"><span class="legend-color legend-resa"></span> R√©serv√© DIGIY</div>
            <div class="legend-item"><span class="legend-color legend-ota"></span> Occup√© Booking / OTA</div>
            <div class="legend-item"><span class="legend-color legend-ferme"></span> Ferm√©</div>
          </div>
        </div>
      </div>
    </section>

    <section class="table-wrap">
      <table>
        <thead id="theadRow"></thead>
        <tbody id="tbodyRows"></tbody>
      </table>
    </section>

    <section class="grid-2">
      <article class="card" id="cardForm">
        <h2>Ajouter une r√©servation</h2>

        <form id="resaForm">
          <div class="field-row">
            <div class="field-col">
              <label class="required" for="guestName">Nom du client</label>
              <input id="guestName" placeholder="Ex. Famille Ndiaye" required>
            </div>
            <div class="field-col">
              <label for="phone">T√©l√©phone / WhatsApp</label>
              <input id="phone" placeholder="+221 77 ‚Ä¶">
            </div>
          </div>

          <div class="field-row">
            <div class="field-col">
              <label class="required" for="checkIn">Arriv√©e (check-in)</label>
              <input id="checkIn" type="date" required>
            </div>
            <div class="field-col">
              <label class="required" for="checkOut">D√©part (check-out)</label>
              <input id="checkOut" type="date" required>
            </div>
          </div>

          <div class="field-row">
            <div class="field-col">
              <label for="source">Source</label>
              <select id="source">
                <option value="digiy">DIGIY (direct)</option>
                <option value="booking">Booking / OTA</option>
                <option value="autre">Autre</option>
              </select>
              <div class="hint">Juste pour colorer le planning : DIGIY vs OTA.</div>
            </div>
          </div>

          <div class="field-row">
            <div class="field-col">
              <label for="comment">Notes</label>
              <textarea id="comment" placeholder="Ex. Arriv√©e tardive, 4 personnes‚Ä¶"></textarea>
            </div>
          </div>

          <button type="submit" class="btn btn-accent" id="btnSave">ü¶Ö Enregistrer dans Supabase</button>
          <div class="status-msg" id="formStatus"></div>
        </form>
      </article>

      <article class="card">
        <h2>R√©servations √† venir</h2>
        <div id="resaList"></div>
      </article>
    </section>

    <footer class="footer">
      DIGIY LOC PRO ‚Äî Chez Baptiste ‚Ä¢ Planning connect√© Supabase ‚Ä¢ 0% commission, paiement direct.
    </footer>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // =======================
    // CONFIG
    // =======================
    const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // üîÅ Mets TES URLS
    const HUB_URL = "https://beauville.github.io/mon-espace-digiy/";         // ‚Üê ton HUB
    const INSCRIPTION_URL = "https://beauville.github.io/inscription-digiy/"; // ‚Üê login/inscription

    // business / logement
    const BUSINESS_CODE = "chez-baptiste";
    const ROOM_LABEL = "Appartement complet (2 chambres)";
    const ROOM_CODE = "apt-complet";

    // =======================
    // STATE
    // =======================
    let windowStart = new Date();
    windowStart.setHours(0,0,0,0);

    let authUser = null;
    let profileSource = null; // "pros" | "pre_registrations"
    let profileStatus = "unknown";
    let canWrite = false;

    // =======================
    // DOM
    // =======================
    const theadRow = document.getElementById("theadRow");
    const tbodyRows = document.getElementById("tbodyRows");
    const planningTitle = document.getElementById("planningTitle");
    const planningSub = document.getElementById("planningSub");

    const form = document.getElementById("resaForm");
    const formStatus = document.getElementById("formStatus");
    const btnSave = document.getElementById("btnSave");
    const resaList = document.getElementById("resaList");

    const proBanner = document.getElementById("proBanner");
    const debugLine = document.getElementById("debugLine");
    const pillOwner = document.getElementById("pillOwner");
    const pillStatus = document.getElementById("pillStatus");
    const cardForm = document.getElementById("cardForm");

    const btnBackHub = document.getElementById("btnBackHub");
    const btnLogout = document.getElementById("btnLogout");
    const btnReload = document.getElementById("btnReload");

    // =======================
    // HELPERS
    // =======================
    function formatDayLabel(d){
      const jours = ["dim.","lun.","mar.","mer.","jeu.","ven.","sam."];
      const j = jours[d.getDay()];
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      return { j, dd, mm };
    }

    function toISODate(d){ return d.toISOString().slice(0,10); }

    function addDays(d, n){
      const x = new Date(d);
      x.setDate(x.getDate()+n);
      return x;
    }

    function setFormDefaults(){
      const todayISO = toISODate(new Date());
      const tomorrowISO = toISODate(addDays(new Date(),1));
      document.getElementById("checkIn").value = todayISO;
      document.getElementById("checkOut").value = tomorrowISO;
    }

    function setStatus(msg, type){
      formStatus.textContent = msg || "";
      formStatus.className = "status-msg" + (type ? " status-" + type : "");
    }

    function lockWrites(locked, message){
      if(locked){
        cardForm.classList.add("lock");
        btnSave.disabled = true;
        setStatus(message || "√âcriture verrouill√©e.", "warn");
      } else {
        cardForm.classList.remove("lock");
        btnSave.disabled = false;
        setStatus("", "");
      }
    }

    // =======================
    // AUTH + PROFILE CHECK
    // =======================
    async function requireAuth(){
      const { data, error } = await client.auth.getUser();
      if(error || !data || !data.user){
        window.location.href = INSCRIPTION_URL;
        return false;
      }
      authUser = data.user;
      return true;
    }

    async function loadProfile(){
      // 1) Cherche dans pros (si la fiche existe)
      try{
        const { data: proRow, error: proErr } = await client
          .from("pros")
          .select("id, full_name, status, payment_status, is_active, active_modules")
          .eq("auth_user_id", authUser.id)
          .maybeSingle();

        if(!proErr && proRow){
          profileSource = "pros";
          profileStatus = (proRow.status || "pending").toLowerCase();

          const pay = (proRow.payment_status || "pending").toLowerCase();
          const enabled = (proRow.is_active === true);
          canWrite = enabled && (profileStatus === "active") && (pay === "paid" || pay === "active");

          pillOwner.textContent = (proRow.full_name || authUser.email || "PRO").toUpperCase();
          pillStatus.textContent = "PRO ‚Ä¢ " + (canWrite ? "ACTIF" : profileStatus);

          proBanner.innerHTML =
            "‚úÖ Profil trouv√© dans <strong>pros</strong> (" + (canWrite ? "<span class='ok'>ACTIF</span>" : "<span class='ko'>NON ACTIF</span>") + ").<br>" +
            (canWrite
              ? "Tu peux <strong>ajouter</strong> des r√©servations."
              : "Ton compte PRO existe mais n‚Äôest pas actif : <strong>√©criture bloqu√©e</strong>.");
          return;
        }
      } catch(e){
        // ignore, on tente pre_registrations
      }

      // 2) Sinon, cherche dans pre_registrations
      try{
        const { data: preRow, error: preErr } = await client
          .from("pre_registrations")
          .select("id, full_name, status, preferred_module, modules, phone, whatsapp, email, updated_at")
          .eq("auth_user_id", authUser.id)
          .maybeSingle();

        if(preErr || !preRow){
          profileSource = "none";
          profileStatus = "unknown";
          canWrite = false;

          pillOwner.textContent = (authUser.email || "COMPTE").toUpperCase();
          pillStatus.textContent = "STATUT INCONNU";

          proBanner.innerHTML =
            "‚ö†Ô∏è Compte connect√© mais <strong>aucune fiche</strong> trouv√©e dans <strong>pros</strong> ni <strong>pre_registrations</strong>.<br>" +
            "üëâ Reviens au HUB et relance l‚Äôinscription.";
          return;
        }

        profileSource = "pre_registrations";
        profileStatus = (preRow.status || "pre_registered").toLowerCase();
        canWrite = false; // lecture OK, √©criture bloqu√©e tant que pas PRO actif

        pillOwner.textContent = (preRow.full_name || authUser.email || "PR√âINSCRIPTION").toUpperCase();
        pillStatus.textContent = "PR√âINSCRIPTION ‚Ä¢ " + profileStatus;

        proBanner.innerHTML =
          "‚úÖ Ton compte est reconnu (<strong>pr√©inscription</strong>).<br>" +
          "üìå Statut : <strong>" + profileStatus + "</strong> ‚Ä¢ Module : <strong>" + (preRow.preferred_module || "loc").toUpperCase() + "</strong><br>" +
          "üîí Prochaine √©tape : cr√©ation du compte <strong>PRO</strong> (table pros) + activation abonnement.<br>" +
          "üí∏ Paiement Wave : <strong>+221 77 134 28 89</strong> (√©criture bloqu√©e tant que non actif).";
      } catch(e){
        profileSource = "none";
        profileStatus = "unknown";
        canWrite = false;
        proBanner.innerHTML = "‚ö†Ô∏è Erreur lecture profil. V√©rifie Supabase.";
      }
    }

    // =======================
    // DATA LOAD + RENDER
    // =======================
    async function loadAndRender(){
      const start = new Date(windowStart);
      start.setHours(0,0,0,0);
      const end = addDays(start,13);

      const dd1 = String(start.getDate()).padStart(2,"0");
      const mm1 = String(start.getMonth()+1).padStart(2,"0");
      const dd2 = String(end.getDate()).padStart(2,"0");
      const mm2 = String(end.getMonth()+1).padStart(2,"0");

      planningTitle.textContent = "Planning 14 jours ‚Äî " + ROOM_LABEL;
      planningSub.textContent = "Du " + dd1 + "/" + mm1 + " au " + dd2 + "/" + mm2;

      // Header tableau
      theadRow.innerHTML = "";
      const trHead = document.createElement("tr");

      const thLogement = document.createElement("th");
      thLogement.textContent = "Logement";
      trHead.appendChild(thLogement);

      for(let i=0;i<14;i++){
        const d = addDays(start,i);
        const th = document.createElement("th");
        const info = formatDayLabel(d);
        th.innerHTML = '<div class="day-label"><span>'+info.j.toUpperCase()+'</span><span>'+info.dd+'/'+info.mm+'</span></div>';
        trHead.appendChild(th);
      }
      theadRow.appendChild(trHead);

      // Charger r√©sas qui CHEVAUCHENT la fen√™tre :
      // check_in <= end AND check_out >= start
      const fromISO = toISODate(start);
      const toISO = toISODate(end);

      let reservations = [];
      try{
        const { data, error } = await client
          .from("loc_reservations")
          .select("*")
          .eq("business_code", BUSINESS_CODE)
          .lte("check_in", toISO)
          .gte("check_out", fromISO);

        if(error){
          console.error("Erreur chargement r√©servations :", error.message);
          setStatus("Erreur chargement r√©servations : " + error.message, "error");
          reservations = [];
        } else {
          reservations = data || [];
          if(canWrite) setStatus("", "");
        }
      } catch(err){
        console.error(err);
        setStatus("Erreur inattendue lors du chargement des r√©servations.", "error");
        reservations = [];
      }

      // statusByDay
      const statusByDay = {};
      for(let i=0;i<14;i++){
        const d = addDays(start,i);
        statusByDay[toISODate(d)] = "free";
      }

      reservations.forEach(r => {
        const checkIn = new Date(r.check_in);
        const checkOut = new Date(r.check_out);
        checkIn.setHours(0,0,0,0);
        checkOut.setHours(0,0,0,0);

        for(let i=0;i<14;i++){
          const current = addDays(start,i);
          current.setHours(0,0,0,0);
          const key = toISODate(current);

          if(current >= checkIn && current < checkOut){
            const source = (r.source || "").toLowerCase();
            if(source.startsWith("booking") || source.includes("ota")){
              statusByDay[key] = "ota";
            } else {
              statusByDay[key] = "digiy";
            }
          }
        }
      });

      // Corps tableau (une ligne)
      tbodyRows.innerHTML = "";
      const tr = document.createElement("tr");

      const tdLabel = document.createElement("td");
      tdLabel.innerHTML = `
        <div><strong>${ROOM_LABEL}</strong></div>
        <div style="color:var(--muted);font-size:0.9rem;">Capacit√© 4 pers ‚Ä¢ Code : ${ROOM_CODE}</div>
      `;
      tr.appendChild(tdLabel);

      for(let i=0;i<14;i++){
        const d = addDays(start,i);
        const key = toISODate(d);
        const status = statusByDay[key] || "free";

        const td = document.createElement("td");
        const div = document.createElement("div");
        div.classList.add("cell-status");

        if(status === "free"){
          div.classList.add("cell-libre");
          div.textContent = "Libre / R√©servable";
        } else if(status === "digiy"){
          div.classList.add("cell-resa-digiy");
          div.textContent = "R√©serv√© DIGIY";
        } else if(status === "ota"){
          div.classList.add("cell-ota");
          div.textContent = "Occup√© Booking / OTA";
        } else {
          div.classList.add("cell-ferme");
          div.textContent = "Ferm√©";
        }

        td.appendChild(div);
        tr.appendChild(td);
      }

      tbodyRows.appendChild(tr);

      await renderResaList();
    }

    async function renderResaList(){
      resaList.innerHTML = "";
      try{
        const todayISO = toISODate(new Date());
        const { data, error } = await client
          .from("loc_reservations")
          .select("*")
          .eq("business_code", BUSINESS_CODE)
          .gte("check_out", todayISO)
          .order("check_in", { ascending:true });

        if(error){
          console.error(error);
          resaList.innerHTML = '<div class="resa-list-empty">Erreur chargement : '+error.message+'</div>';
          return;
        }

        if(!data || !data.length){
          resaList.innerHTML = '<div class="resa-list-empty">Aucune r√©servation √† venir.</div>';
          return;
        }

        data.forEach(r=>{
          const ci = new Date(r.check_in);
          const co = new Date(r.check_out);
          const dd1 = String(ci.getDate()).padStart(2,"0");
          const mm1 = String(ci.getMonth()+1).padStart(2,"0");
          const dd2 = String(co.getDate()).padStart(2,"0");
          const mm2 = String(co.getMonth()+1).padStart(2,"0");

          const source = (r.source || "digiy").toLowerCase();
          let sourceLabel = "DIGIY";
          if(source.startsWith("booking") || source.includes("ota")) sourceLabel = "Booking / OTA";
          else if(source === "autre") sourceLabel = "Autre";

          const div = document.createElement("div");
          div.className = "resa-item";
          div.innerHTML = `
            <div><strong>${r.guest_name || "Client"}</strong> ‚Äî du ${dd1}/${mm1} au ${dd2}/${mm2}</div>
            <div class="resa-meta">
              Source : ${sourceLabel}
              ${r.phone ? " ‚Ä¢ Tel : "+r.phone : ""}
            </div>
          `;
          resaList.appendChild(div);
        });
      } catch(err){
        console.error(err);
        resaList.innerHTML = '<div class="resa-list-empty">Erreur inattendue.</div>';
      }
    }

    // =======================
    // EVENTS
    // =======================
    document.getElementById("btnPrev").addEventListener("click", ()=>{
      windowStart = addDays(windowStart, -14);
      loadAndRender();
    });
    document.getElementById("btnNext").addEventListener("click", ()=>{
      windowStart = addDays(windowStart, 14);
      loadAndRender();
    });
    document.getElementById("btnToday").addEventListener("click", ()=>{
      windowStart = new Date(); windowStart.setHours(0,0,0,0);
      loadAndRender();
    });

    btnBackHub.addEventListener("click", (e)=>{
      e.preventDefault();
      window.location.href = HUB_URL;
    });

    btnReload.addEventListener("click", ()=>{
      window.location.reload();
    });

    btnLogout.addEventListener("click", async ()=>{
      try{ await client.auth.signOut(); } catch(e){}
      window.location.href = INSCRIPTION_URL;
    });

    // SUBMIT
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();

      if(!canWrite){
        setStatus("üîí Compte non actif : tu peux lire le planning, mais pas ajouter de r√©sas.", "warn");
        return;
      }

      setStatus("", "");
      btnSave.disabled = true;

      const guestName = document.getElementById("guestName").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const checkIn = document.getElementById("checkIn").value;
      const checkOut = document.getElementById("checkOut").value;
      const source = document.getElementById("source").value;
      const comment = document.getElementById("comment").value.trim();

      if(!guestName || !checkIn || !checkOut){
        setStatus("Merci de remplir au minimum le nom, l'arriv√©e et le d√©part.", "error");
        btnSave.disabled = false;
        return;
      }
      if(checkOut <= checkIn){
        setStatus("La date de d√©part doit √™tre apr√®s la date d'arriv√©e.", "error");
        btnSave.disabled = false;
        return;
      }

      try{
        const payload = {
          business_code: BUSINESS_CODE,
          room_label: ROOM_LABEL,
          room_code: ROOM_CODE,
          guest_name: guestName,
          phone: phone || null,
          source: source || "digiy",
          check_in: checkIn,
          check_out: checkOut,
          status: "confirmed",
          comment: comment || null
        };

        const { error } = await client.from("loc_reservations").insert([payload]);

        if(error){
          console.error("Erreur insert", error);
          setStatus("Erreur enregistrement : " + error.message, "error");
        } else {
          setStatus("üéâ R√©servation enregistr√©e. Planning mis √† jour.", "success");
          form.reset();
          setFormDefaults();
          await loadAndRender();
        }
      } catch(err){
        console.error(err);
        setStatus("Erreur inattendue. R√©essaie.", "error");
      } finally {
        btnSave.disabled = false;
      }
    });

    // =======================
    // INIT
    // =======================
    document.addEventListener("DOMContentLoaded", async ()=>{
      btnBackHub.href = HUB_URL;
      setFormDefaults();

      const ok = await requireAuth();
      if(!ok) return;

      debugLine.textContent = "auth=" + String(authUser.id).slice(0,8);

      await loadProfile();

      // verrou √©criture si pas actif
      lockWrites(!canWrite, "üîí √âcriture bloqu√©e : active ton compte PRO (paiement Wave) pour ajouter des r√©sas.");

      // si tu veux autoriser √©criture aux PRO m√™me non 'active', change ici (mais je d√©conseille)
      await loadAndRender();

      debugLine.textContent =
        "source=" + (profileSource || "none") +
        " ‚Ä¢ status=" + (profileStatus || "unknown") +
        " ‚Ä¢ auth=" + String(authUser.id).slice(0,8);
    });
  </script>
</body>
</html>
