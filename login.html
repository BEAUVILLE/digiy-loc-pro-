<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY LOC ‚Ä¢ PRO ‚Äî Connexion (PIN)</title>
  <meta name="theme-color" content="#16a34a"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.75);
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:18px;
    }
    body{
      margin:0; min-height:100vh; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:radial-gradient(900px 500px at 10% -10%, rgba(34,197,94,.20), transparent 60%), var(--bg);
      color:var(--text);
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    .wrap{width:min(720px, 100%);}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:0 20px 55px rgba(0,0,0,.35);
    }
    h1{margin:4px 0 6px; font-size:20px}
    .muted{color:var(--muted)}
    .grid{display:grid; grid-template-columns:1fr; gap:12px; margin-top:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    input{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-weight:800;
      letter-spacing:.2px;
    }
    input::placeholder{color:rgba(234,255,241,.55)}
    button{
      cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      font-weight:900;
    }
    button.primary{
      border-color:rgba(34,197,94,.55);
      background:rgba(34,197,94,.16);
    }
    button:disabled{opacity:.55; cursor:not-allowed}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      font-size:12px;
      font-weight:900;
    }
    .ok{border-color:rgba(34,197,94,.55); background:rgba(34,197,94,.12)}
    .bad{border-color:rgba(239,68,68,.55); background:rgba(239,68,68,.12)}
    .warn{border-color:rgba(245,158,11,.55); background:rgba(245,158,11,.12)}
    .small{font-size:12px}
    .sep{height:1px; background:var(--line); margin:14px 0}
    code{background:rgba(0,0,0,.25); padding:2px 6px; border-radius:8px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>üîê DIGIY LOC ‚Ä¢ PRO ‚Äî Acc√®s par PIN</h1>
      <div class="muted">
        Connexion terrain : <b>t√©l√©phone WhatsApp</b> + <b>PIN</b>.
        Pas d‚Äôemail. Pas de magie. Juste du solide.
      </div>

      <div class="sep"></div>

      <div class="grid">
        <div class="row">
          <div class="pill warn" id="pill">√âtat: PIN requis</div>
          <div class="pill" id="hint">Astuce: PIN 4‚Äì8 chiffres</div>
        </div>

        <div>
          <label class="small muted">T√©l√©phone (S√©n√©gal)</label>
          <input id="phone" type="tel" placeholder="+221771234567" inputmode="tel" autocomplete="tel"/>
          <div class="muted small">Format conseill√©: <code>+221XXXXXXXXX</code></div>
        </div>

        <div>
          <label class="small muted">PIN</label>
          <input id="pin" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric" autocomplete="current-password"/>
        </div>

        <div class="row">
          <button class="primary" id="btnLogin">‚úÖ Entrer</button>
          <button id="btnClear">üßπ Clear</button>
        </div>

        <div class="muted small" id="msg"></div>

        <div class="sep"></div>

        <div class="muted small">
          <b>Entrer</b> ouvre LOC PRO si ton abonnement est actif.
          <br/>Si ton PIN est faux ‚Üí acc√®s refus√©.
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  "use strict";

  // =============================
  // SUPABASE
  // =============================
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // =============================
  // ROUTES (adjust if needed)
  // =============================
  const MODULE = "LOC";
  const DASHBOARD_URL = "./planning.html";
  const PAY_URL = "https://beauville.github.io/commencer-a-payer/";

  // Session storage keys (shared with guard)
  const KEY = {
    phone: "digiy_phone",
    sess: "digiy_loc_session" // { phone, token, exp }
  };

  const $ = (id)=>document.getElementById(id);
  const phoneEl = $("phone");
  const pinEl = $("pin");
  const pill = $("pill");
  const msg = $("msg");
  const btnLogin = $("btnLogin");
  const btnClear = $("btnClear");

  // =============================
  // UI
  // =============================
  function setPill(type, text){
    pill.className = "pill " + (type || "");
    pill.textContent = text;
  }
  function setMsg(t){ msg.textContent = t || ""; }

  // =============================
  // UTILS
  // =============================
  function normPhone(p){
    p = String(p||"").trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");
    if(p.startsWith("00221")) p = "+221" + p.slice(5);
    if(!p.startsWith("+") && p.startsWith("221")) p = "+" + p;
    if(!p.startsWith("+221") && /^\d{9}$/.test(p)) p = "+221" + p;
    return p;
  }

  function savePhone(phone){
    const p = normPhone(phone);
    sessionStorage.setItem(KEY.phone, p);
    sessionStorage.setItem("digiy_driver_phone", p); // compat
    return p;
  }

  function loadPhone(){
    const s = sessionStorage.getItem(KEY.phone) || sessionStorage.getItem("digiy_driver_phone");
    if(s) return s;
    try{
      const sess = JSON.parse(localStorage.getItem(KEY.sess)||"null");
      return sess?.phone || "";
    }catch(_){ return ""; }
  }

  function getSession(){
    try{
      const s = JSON.parse(localStorage.getItem(KEY.sess)||"null");
      if(!s?.token || !s?.phone || !s?.exp) return null;
      if(Date.now() > Number(s.exp)) return null;
      return s;
    }catch(_){ return null; }
  }

  function setSession({ phone, token, exp_ms }){
    const obj = {
      phone: normPhone(phone),
      token: String(token),
      exp: Date.now() + Number(exp_ms || 0)
    };
    localStorage.setItem(KEY.sess, JSON.stringify(obj));
    savePhone(obj.phone);
    return obj;
  }

  function clearAll(){
    sessionStorage.removeItem(KEY.phone);
    sessionStorage.removeItem("digiy_driver_phone");
    try{ localStorage.removeItem(KEY.sess); }catch(_){}
    phoneEl.value = "";
    pinEl.value = "";
    setMsg("Cache vid√©.");
    setPill("warn", "√âtat: PIN requis");
  }

  function withQuery(url, params){
    const u = new URL(url, location.href);
    Object.entries(params||{}).forEach(([k,v])=>{
      if(v===undefined || v===null || v==="") return;
      u.searchParams.set(k, String(v));
    });
    return u.toString();
  }

  async function rpc(name, args){
    const { data, error } = await sb.rpc(name, args || {});
    if(error) throw error;
    return data;
  }

  // =============================
  // SECURITY (small anti-bruteforce UI)
  // =============================
  let tries = 0;
  let lockUntil = 0;
  function isLocked(){
    return Date.now() < lockUntil;
  }
  function lockShort(){
    tries += 1;
    if(tries >= 5){
      lockUntil = Date.now() + 30_000; // 30s
      tries = 0;
      return true;
    }
    return false;
  }

  // =============================
  // FLOW
  // =============================
  async function alreadyLoggedIn(){
    const sess = getSession();
    if(!sess) return false;

    setPill("warn", "√âtat: v√©rif session‚Ä¶");
    setMsg("Session trouv√©e, v√©rification‚Ä¶");

    const ok = await rpc("digiy_loc_session_validate", {
      p_phone: sess.phone,
      p_token: sess.token
    }).catch(()=>false);

    if(!ok){
      try{ localStorage.removeItem(KEY.sess); }catch(_){}
      setPill("warn", "√âtat: PIN requis");
      setMsg("");
      return false;
    }

    // session OK -> check subscription
    const active = await rpc("is_module_active", { p_phone: sess.phone, p_module: MODULE }).catch(()=>false);

    if(!active){
      setPill("warn", "√âtat: abonnement inactif");
      setMsg("Abonnement LOC inactif ‚Üí redirection paiement‚Ä¶");
      location.replace(withQuery(PAY_URL, { module: MODULE, phone: sess.phone, from: location.href }));
      return true;
    }

    setPill("ok", "√âtat: ‚úÖ OK");
    setMsg("Session OK. Redirection‚Ä¶");
    location.replace(DASHBOARD_URL);
    return true;
  }

  async function login(){
    if(isLocked()){
      const left = Math.ceil((lockUntil - Date.now())/1000);
      setPill("bad", "√âtat: verrouill√©");
      setMsg("Trop d'essais. Attends " + left + "s puis r√©essaie.");
      return;
    }

    const phone = savePhone(phoneEl.value || "");
    const pin = String(pinEl.value || "").trim();

    if(!phone){ alert("T√©l√©phone requis"); return; }
    if(!pin){ alert("PIN requis"); return; }

    btnLogin.disabled = true;
    setPill("warn", "√âtat: v√©rification‚Ä¶");
    setMsg("V√©rification PIN‚Ä¶");

    try{
      // 1) verify PIN (SERVER)
      const v = await rpc("digiy_access_pin_verify", {
        p_phone: phone,
        p_pin: pin,
        p_module: MODULE
      });

      if(!v || v.ok !== true){
        const locked = lockShort();
        setPill("bad", "√âtat: ‚ùå PIN incorrect");
        setMsg(locked ? "PIN incorrect. Pause 30s (s√©curit√©)." : "PIN incorrect. R√©essaie.");
        return;
      }

      // 2) create short session token (SERVER)
      setMsg("PIN OK ‚úÖ Cr√©ation session‚Ä¶");
      const s = await rpc("digiy_loc_session_create", {
        p_phone: phone,
        p_user_agent: (navigator.userAgent || null)
      });

      if(!s || s.ok !== true || !s.token){
        setPill("bad", "√âtat: ‚ùå session refus√©e");
        setMsg("Session non cr√©√©e. R√©essaie.");
        return;
      }

      setSession({ phone: s.phone || phone, token: s.token, exp_ms: s.exp_ms || (12*60*60*1000) });

      // 3) subscription
      setMsg("Session OK ‚úÖ V√©rification abonnement LOC‚Ä¶");
      const active = await rpc("is_module_active", { p_phone: (s.phone || phone), p_module: MODULE }).catch(()=>false);

      if(!active){
        setPill("warn", "√âtat: abonnement inactif");
        setMsg("Abonnement LOC inactif ‚Üí redirection paiement‚Ä¶");
        location.replace(withQuery(PAY_URL, { module: MODULE, phone: (s.phone || phone), from: location.href }));
        return;
      }

      // 4) go
      setPill("ok", "√âtat: ‚úÖ OK");
      setMsg("Acc√®s accord√© ‚úÖ Redirection‚Ä¶");
      setTimeout(()=>location.replace(DASHBOARD_URL), 250);

    }catch(e){
      console.warn(e);
      setPill("bad", "√âtat: ‚ùå erreur");
      setMsg("Erreur: " + (e?.message || e));
    }finally{
      btnLogin.disabled = false;
    }
  }

  // =============================
  // EVENTS
  // =============================
  btnLogin.addEventListener("click", ()=>login());
  btnClear.addEventListener("click", clearAll);

  // Enter key
  [phoneEl, pinEl].forEach(el=>{
    el.addEventListener("keydown", (e)=>{
      if(e.key === "Enter") login();
    });
  });

  // =============================
  // INIT
  // =============================
  phoneEl.value = loadPhone();
  setPill("warn", "√âtat: PIN requis");
  setMsg("");

  // Auto-redirect if already logged in
  alreadyLoggedIn().catch(()=>{});
})();
</script>
</body>
</html>

