<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY LOC ‚Ä¢ PRO ‚Äî Acc√®s par PIN</title>
  <meta name="theme-color" content="#16a34a"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./guard.js?v=locpro-2"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.75);
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:860px; margin:0 auto; padding:16px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:14px; }
    h1{ margin:0 0 6px; font-size:18px; font-weight:900; }
    p{ margin:6px 0; color:var(--muted); line-height:1.35; }
    label{ display:block; margin:10px 0 6px; color:var(--muted); font-weight:800; }
    input{
      width:100%;
      border:1px solid var(--line); background:rgba(0,0,0,.15);
      color:var(--text); padding:12px 12px; border-radius:14px;
      outline:none; font-size:16px;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .btn{
      border:1px solid var(--line); background:transparent; color:var(--text);
      padding:10px 12px; border-radius:14px; cursor:pointer; font-weight:900;
      min-height:44px;
    }
    .btn.ok{ border-color:rgba(34,197,94,.6); }
    .btn.bad{ border-color:rgba(239,68,68,.55); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:999px; }
    .status{ margin-top:10px; font-weight:900; }
    .status.ok{ color:var(--ok); }
    .status.bad{ color:var(--bad); }
    .status.warn{ color:var(--warn); }
    .small{ font-size:13px; color:var(--muted); }
    .sep{ height:10px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <h1>üîê DIGIY LOC ‚Ä¢ PRO ‚Äî Acc√®s par PIN</h1>
          <p>Connexion terrain : t√©l√©phone WhatsApp + PIN. Pas d‚Äôemail. Pas de magie. Juste du solide.</p>
        </div>
        <span class="pill mono" id="pillSlug">slug: ‚Äî</span>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div class="pill">√âtat: <span id="etat">‚Äî</span></div>
        <div class="pill">Module: <span class="mono" id="pillModule">LOC</span></div>
        <div class="pill">Astuce: PIN 4‚Äì8 chiffres</div>
      </div>

      <label for="phone">T√©l√©phone (S√©n√©gal)</label>
      <input id="phone" inputmode="tel" autocomplete="tel" placeholder="+221771234567"/>
      <div class="small">Format conseill√©: +221XXXXXXXXX (ou juste 9 chiffres)</div>

      <label for="pin">PIN</label>
      <input id="pin" inputmode="numeric" autocomplete="one-time-code" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

      <div class="sep"></div>

      <div class="row">
        <button class="btn ok" id="btnEnter">‚úÖ Entrer</button>
        <button class="btn" id="btnClear">üßπ Clear</button>
        <button class="btn bad" id="btnForgot">‚ùì PIN oubli√©</button>
      </div>

      <div class="status warn" id="status">PIN requis</div>
      <div class="small" id="hint"></div>
    </div>
  </div>

  <script>
  (function(){
    const MODULE = "LOC";
    const PAY_URL = "https://beauville.github.io/commencer-a-payer/";
    const SUPPORT_WA = "+221771342889";

    const $ = (id)=>document.getElementById(id);

    function setEtat(t){ $("etat").textContent = t; }
    function setStatus(msg, cls){
      $("status").textContent = msg;
      $("status").className = "status " + (cls || "warn");
    }
    function setHint(msg){ $("hint").textContent = msg || ""; }

    function lock(on){
      $("btnEnter").disabled = !!on;
      $("btnClear").disabled = !!on;
      $("btnForgot").disabled = !!on;
      $("phone").disabled = !!on;
      $("pin").disabled = !!on;
    }

    function withSlug(u){
      return (window.DIGIY_GUARD?.withSlug ? window.DIGIY_GUARD.withSlug(u) : u);
    }

    if(!window.DIGIY_GUARD || typeof window.DIGIY_GUARD.loginWithPin !== "function"){
      setEtat("Guard absent");
      setStatus("Erreur: guard.js non charg√© (DIGIY_GUARD introuvable).", "bad");
      setHint("V√©rifie que guard.js est bien charg√© (et que supabase-js est avant).");
      return;
    }

    // slug UI
    const slug = window.DIGIY_GUARD.getSlug ? window.DIGIY_GUARD.getSlug() : "";
    $("pillSlug").textContent = "slug: " + (slug || "‚Äî");
    $("pillModule").textContent = MODULE;

    // Prefill phone si connu
    try{
      const p = window.DIGIY_GUARD.getPhone && window.DIGIY_GUARD.getPhone();
      if(p) $("phone").value = p;
    }catch(_){}

    // ‚úÖ Si d√©j√† une session valide ‚Üí le guard redirige (planning / pay / diagnostic)
    try{
      const sess = window.DIGIY_GUARD.getSession ? window.DIGIY_GUARD.getSession() : null;
      if(sess && sess.phone){
        setEtat("Session d√©tect√©e");
        setStatus("‚è≥ V√©rification abonnement‚Ä¶", "warn");

        window.DIGIY_GUARD.boot({
          module: MODULE,
          login: "./pin.html",
          dashboard: "./planning.html",
          pay: PAY_URL,
          diagnostic: "./health-loc.html",
          requireSlug: true,
          checkSubscription: true,
          redirectToDashboard: true // ‚úÖ le guard d√©cide & redirige si OK
        });
        return;
      }
    }catch(_){}

    setEtat("Pr√™t");
    setStatus("PIN requis", "warn");

    $("btnClear").onclick = ()=>{
      $("pin").value = "";
      setStatus("PIN requis", "warn");
      setHint("");
      $("pin").focus();
    };

    $("btnForgot").onclick = ()=>{
      const rawPhone = ($("phone").value || "").trim();
      const phone = window.DIGIY_GUARD.normPhone ? window.DIGIY_GUARD.normPhone(rawPhone) : rawPhone;
      const s = window.DIGIY_GUARD.getSlug ? window.DIGIY_GUARD.getSlug() : "";

      const msg =
`DIGIY ‚Ä¢ Support LOC PRO
Demande: Reset PIN

Module: ${MODULE}
Slug: ${s || "‚Äî"}
T√©l√©phone: ${phone || "‚Äî"}

Merci. ‚Äî DIGIY`;

      const url = "https://wa.me/" + SUPPORT_WA.replace(/[^\d]/g,"") + "?text=" + encodeURIComponent(msg);
      window.location.href = url;
    };

    async function doLogin(){
      const rawPhone = ($("phone").value || "").trim();
      const pin = ($("pin").value || "").trim();
      const phone = window.DIGIY_GUARD.normPhone ? window.DIGIY_GUARD.normPhone(rawPhone) : rawPhone;

      if(!phone){ setStatus("T√©l√©phone requis.", "bad"); $("phone").focus(); return; }
      if(!pin || pin.length < 4){ setStatus("PIN invalide (4‚Äì8 chiffres).", "bad"); $("pin").focus(); return; }

      lock(true);
      setStatus("‚è≥ V√©rification PIN‚Ä¶", "warn");
      setHint("");

      try{
        const out = await window.DIGIY_GUARD.loginWithPin(phone, pin, MODULE);

        if(!out || out.ok !== true){
          const reason = out?.res?.reason ? String(out.res.reason) : "";
          setStatus("‚ùå PIN incorrect. R√©essaie.", "bad");
          setHint(reason ? ("Raison: " + reason) : "Si tu as oubli√©: clique ‚ÄúPIN oubli√©‚Äù.");
          lock(false);
          return;
        }

        setStatus("‚úÖ OK. V√©rification abonnement‚Ä¶", "ok");

        // ‚úÖ Apr√®s PIN OK, le guard d√©cide la destination
        window.DIGIY_GUARD.boot({
          module: MODULE,
          login: "./pin.html",
          dashboard: "./planning.html",
          pay: PAY_URL,
          diagnostic: "./health-loc.html",
          requireSlug: true,
          checkSubscription: true,
          redirectToDashboard: true // ‚úÖ planning si actif, pay si pas actif, diagnostic si erreur
        });

        // ‚ö†Ô∏è PAS de timeout vers planning : on laisse le guard faire.
      }catch(e){
        console.error(e);
        setStatus("Erreur v√©rification (r√©seau / Supabase / RPC).", "bad");
        setHint(String(e?.message || e));
        lock(false);
      }
    }

    $("btnEnter").onclick = doLogin;
    $("pin").addEventListener("keydown", (ev)=>{ if(ev.key === "Enter") doLogin(); });
  })();
</script>
</body>
</html>

