<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY LOC ‚Ä¢ PRO ‚Äî Connexion (PIN)</title>
  <meta name="theme-color" content="#16a34a"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.75);
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:18px;
    }
    body{
      margin:0; min-height:100vh; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:radial-gradient(900px 500px at 10% -10%, rgba(34,197,94,.20), transparent 60%), var(--bg);
      color:var(--text);
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    .wrap{width:min(720px, 100%);}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:0 20px 55px rgba(0,0,0,.35);
    }
    h1{margin:4px 0 6px; font-size:20px}
    .muted{color:var(--muted)}
    .grid{display:grid; grid-template-columns:1fr; gap:12px; margin-top:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    input{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-weight:800;
      letter-spacing:.2px;
    }
    input::placeholder{color:rgba(234,255,241,.55)}
    button{
      cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      font-weight:900;
    }
    button.primary{
      border-color:rgba(34,197,94,.55);
      background:rgba(34,197,94,.16);
    }
    button:disabled{opacity:.55; cursor:not-allowed}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      font-size:12px;
      font-weight:900;
    }
    .ok{border-color:rgba(34,197,94,.55); background:rgba(34,197,94,.12)}
    .bad{border-color:rgba(239,68,68,.55); background:rgba(239,68,68,.12)}
    .warn{border-color:rgba(245,158,11,.55); background:rgba(245,158,11,.12)}
    .small{font-size:12px}
    .sep{height:1px; background:var(--line); margin:14px 0}
    code{background:rgba(0,0,0,.25); padding:2px 6px; border-radius:8px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>üîê DIGIY LOC ‚Ä¢ PRO ‚Äî Acc√®s par PIN</h1>
      <div class="muted">
        Connexion terrain : <b>t√©l√©phone WhatsApp</b> + <b>PIN</b>.
        Pas d‚Äôemail. Pas de magie. Juste du solide.
      </div>

      <div class="sep"></div>

      <div class="grid">
        <div class="row">
          <div class="pill" id="pill">√âtat: ‚Ä¶</div>
          <div class="pill warn" id="hint">Astuce: PIN 4‚Äì6 chiffres</div>
        </div>

        <div>
          <label class="small muted">T√©l√©phone (S√©n√©gal)</label>
          <input id="phone" type="tel" placeholder="+221771234567" inputmode="tel" autocomplete="tel"/>
          <div class="muted small">Format conseill√©: <code>+221XXXXXXXXX</code></div>
        </div>

        <div>
          <label class="small muted">PIN</label>
          <input id="pin" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric" autocomplete="current-password"/>
        </div>

        <div class="row">
          <button class="primary" id="btnLogin">‚úÖ Entrer</button>
          <button id="btnReset">üîÅ Cr√©er/Changer PIN</button>
          <button id="btnClear">üßπ Clear</button>
        </div>

        <div class="muted small" id="msg"></div>

        <div class="sep"></div>

        <div class="muted small">
          <b>Entrer</b> ouvre LOC PRO si ton abonnement est actif.
          <br/>Si tu dois d√©finir ton PIN, clique <b>Cr√©er/Changer PIN</b>.
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  "use strict";

  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id)=>document.getElementById(id);
  const phoneEl = $("phone");
  const pinEl = $("pin");
  const pill = $("pill");
  const msg = $("msg");

  function setPill(ok, text){
    pill.className = "pill " + (ok ? "ok" : "bad");
    pill.textContent = text;
  }

  function normPhone(p){
    p = String(p||"").trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");
    if(p.startsWith("00221")) p = "+221" + p.slice(5);
    if(!p.startsWith("+") && p.startsWith("221")) p = "+" + p;
    if(!p.startsWith("+221") && /^\d{9}$/.test(p)) p = "+221" + p;
    return p;
  }

  function savePhone(phone){
    const p = normPhone(phone);
    sessionStorage.setItem("digiy_phone", p);
    sessionStorage.setItem("digiy_driver_phone", p);
    try{
      localStorage.setItem("digiy_access_pin", JSON.stringify({ phone: p }));
      localStorage.setItem("digiy_driver_access_pin", JSON.stringify({ phone: p }));
    }catch(_){}
    return p;
  }

  function loadPhone(){
    const s = sessionStorage.getItem("digiy_phone") || sessionStorage.getItem("digiy_driver_phone");
    if(s) return s;
    try{
      const a = JSON.parse(localStorage.getItem("digiy_access_pin")||"null");
      return a?.phone || "";
    }catch(_){ return ""; }
  }

  async function checkPin(phone, pin){
    const { data, error } = await sb.rpc("check_pin", { p_phone: phone, p_pin: pin });
    if(error) throw error;
    return !!data;
  }

  async function setPin(phone, pin){
    const { data, error } = await sb.rpc("set_pin", { p_phone: phone, p_pin: pin });
    if(error) throw error;
    return data;
  }

  async function isActive(phone){
    const { data, error } = await sb.rpc("is_module_active", { p_phone: phone, p_module: "LOC" });
    if(error) throw error;
    return !!data;
  }

  async function login(){
    const phone = savePhone(phoneEl.value || "");
    const pin = (pinEl.value || "").trim();

    if(!phone) return alert("T√©l√©phone requis");
    if(!pin) return alert("PIN requis");

    msg.textContent = "V√©rification PIN‚Ä¶";
    setPill(false, "√âtat: v√©rification‚Ä¶");

    const ok = await checkPin(phone, pin);
    if(!ok){
      msg.textContent = "PIN incorrect. Si tu n‚Äôas pas de PIN, clique ‚ÄúCr√©er/Changer PIN‚Äù.";
      setPill(false, "√âtat: ‚ùå PIN incorrect");
      return;
    }

    msg.textContent = "PIN OK ‚úÖ V√©rification abonnement LOC‚Ä¶";
    const active = await isActive(phone);

    if(!active){
      msg.textContent = "Abonnement LOC inactif ‚Üí redirection paiement‚Ä¶";
      setPill(false, "√âtat: ‚ö†Ô∏è abonnement inactif");
      const from = location.href;
      location.replace("https://beauville.github.io/commencer-a-payer/"
        + "?module=LOC&phone=" + encodeURIComponent(phone)
        + "&from=" + encodeURIComponent(from));
      return;
    }

    msg.textContent = "Acc√®s accord√© ‚úÖ Redirection planning‚Ä¶";
    setPill(true, "√âtat: ‚úÖ OK");
    setTimeout(()=>location.replace("./planning.html"), 350);
  }

  async function resetPin(){
    const phone = savePhone(phoneEl.value || "");
    const pin = (pinEl.value || "").trim();
    if(!phone) return alert("T√©l√©phone requis");
    if(!pin) return alert("PIN requis (4 √† 8 chiffres)");

    msg.textContent = "Enregistrement du PIN‚Ä¶";
    setPill(false, "√âtat: enregistrement‚Ä¶");
    await setPin(phone, pin);
    msg.textContent = "PIN enregistr√© ‚úÖ Tu peux cliquer ‚ÄúEntrer‚Äù.";
    setPill(true, "√âtat: ‚úÖ PIN OK");
  }

  function clearAll(){
    sessionStorage.removeItem("digiy_phone");
    sessionStorage.removeItem("digiy_driver_phone");
    localStorage.removeItem("digiy_access_pin");
    localStorage.removeItem("digiy_driver_access_pin");
    phoneEl.value = "";
    pinEl.value = "";
    msg.textContent = "Cache vid√©.";
    setPill(false, "√âtat: ‚Ä¶");
  }

  $("btnLogin").addEventListener("click", ()=>login().catch(e=>{
    console.warn(e);
    msg.textContent = "Erreur: " + (e?.message || e);
    setPill(false, "√âtat: ‚ùå erreur");
  }));

  $("btnReset").addEventListener("click", ()=>resetPin().catch(e=>{
    console.warn(e);
    msg.textContent = "Erreur: " + (e?.message || e);
    setPill(false, "√âtat: ‚ùå erreur");
  }));

  $("btnClear").addEventListener("click", clearAll);

  // init
  phoneEl.value = loadPhone();
  setPill(false, "√âtat: PIN requis");
})();
</script>
</body>
</html>
